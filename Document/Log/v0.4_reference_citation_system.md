# Version 0.4 - Reference Citation System

**Date**: 2026-02-09  
**Status**: Implemented

## Overview

Implemented a full academic-style reference citation system for the website footer. Users can now manage a dynamic list of references, insert citations into content using an '@' mention system, and navigate from citations to references with smooth scroll and highlight effects.

## Features Implemented

### 1. Dynamic Reference List Management

**Data Structure Change**:
- Transformed `material.json` footer reference from a single `body` string to a structured `items` array
- Each reference item has:
  - `id`: Numeric identifier (auto-incremented)
  - `text`: Reference content (supports HTML including citation superscripts)

**Before**:
```json
"reference": {
  "title": "Reference",
  "body": "[1] Add IEEE or other academic references here."
}
```

**After**:
```json
"reference": {
  "title": "Reference",
  "items": [
    { "id": 1, "text": "Add IEEE or other academic references here." }
  ]
}
```

**Migration Support**:
- Footer template includes automatic migration logic
- If `items` array is missing but `body` exists, converts to single-item array
- Maintains backward compatibility with old material format

### 2. Reference Editing Features (Edit Mode)

**Add Reference Button**:
- "+" button appears at the bottom of reference list (edit-mode-only visibility)
- Creates new reference with auto-incremented ID
- Automatically focuses the new reference for immediate editing
- New references start with placeholder text: "New reference entry. Click to edit."

**Delete Reference Button**:
- Small "x" button appears on hover for each reference item
- Only visible in edit mode via `.edit-mode-only` CSS class
- Deleting a reference triggers:
  1. Confirmation dialog
  2. Removal from items array
  3. Automatic renumbering of remaining references (1, 2, 3, ...)
  4. Update of all citations in the document to match new numbering
  5. Removal of orphaned citations (those pointing to deleted reference)
  6. Re-render of entire page

**Inline Reference Editing**:
- Each reference text is contentEditable with `data-material` attribute
- Path format: `footer.reference.items.{index}.text`
- Supports HTML content (preserves citation superscripts)
- Uses `innerHTML` for reading/writing to preserve embedded citations

### 3. '@' Mention Citation System

**Trigger**:
- While editing any `[data-material]` contentEditable field, type '@' character
- System detects '@' within last 20 characters before cursor

**Dropdown UI**:
- Appears at caret position using `Range.getBoundingClientRect()`
- Shows all available references in a styled popup menu
- Each option displays: `[n] First 60 characters of reference text...`
- Glassmorphism design with dark background and blur effect
- Maximum height 300px with scroll for many references

**Keyboard Navigation**:
- **Arrow Up/Down**: Navigate through reference options
- **Enter**: Insert selected reference citation
- **Escape**: Close dropdown without inserting

**Mouse Interaction**:
- Click any reference option to insert citation
- Click outside dropdown to close
- Hover highlights options

**Citation Insertion**:
1. Removes the '@' character from text
2. Creates a `<sup class="ref-cite" data-ref-id="{n}">[{n}]</sup>` element
3. Inserts superscript at cursor position
4. Maintains cursor position after citation
5. Triggers auto-save via blur event

### 4. Citation Click-to-Jump Navigation

**Click Behavior**:
- Click any citation superscript (e.g., `[1]`, `[2]`) anywhere on the page
- Smoothly scrolls to corresponding reference in footer
- Reference element has `id="ref-{n}"` for targeting
- Uses `scrollIntoView({ behavior: 'smooth', block: 'center' })`

**Highlight Animation**:
- Target reference receives `.ref-highlight` class on scroll
- CSS keyframe animation (`highlight-pulse`) provides:
  - Cyan/blue background glow (rgba(34, 211, 238, 0.3) peak)
  - Border pulse effect
  - 2-second fade-out animation
- Automatically removes highlight class after animation completes

**Universal Availability**:
- Works in both View and Edit modes
- Event delegation on document level for performance
- Handlers initialized in `section-renderer.js` during component initialization

### 5. CSS Styling Additions

**`.ref-cite` (Citation Superscript)**:
- Blue accent color (`@apply text-accent-blue`)
- Superscript positioning (`vertical-align: super; font-size: 0.75em`)
- Pointer cursor for clickability
- Hover effect: underline and lighter blue
- Smooth color transition (0.2s)

**`.ref-item` (Reference Row)**:
- Flexbox layout with gap for number, text, and delete button
- Padding and margin for hover interaction area
- Transparent border for smooth highlight animation
- Border-radius for modern appearance

**`.ref-highlight` (Animation)**:
- Keyframe animation `highlight-pulse` over 2 seconds
- Starts with strong cyan glow and visible border
- Fades to transparent over time
- Easing function: `ease-out`

**`.ref-dropdown` (Mention Popup)**:
- Fixed positioning at caret coordinates
- Dark glassmorphism background (rgba(17, 17, 17, 0.95) + backdrop-blur)
- Rounded corners (12px border-radius)
- Drop shadow for depth
- Scrollable with max-height 300px
- Z-index 1000 for top layer

**`.ref-dropdown-item`**:
- Hover and selected states with background overlay
- Color transition from muted to white
- Number in accent blue color
- Text truncation with ellipsis

**`.edit-mode-only`**:
- `display: none` by default
- `display: flex` when `body.edit-mode` class exists
- Applied to: add button, delete buttons

### 6. Implementation Architecture

**Files Modified**:

#### `material.json`
- Updated footer reference structure to items array
- Initial example reference maintained

#### `js/templates.js` - Footer Template
- Added migration logic for backward compatibility
- Dynamic rendering of reference items list
- Each item includes:
  - ID anchor for scroll targeting
  - Editable text field with `data-ref-content="true"` marker
  - Delete button (edit-mode-only)
- Add reference button at list bottom

#### `js/editor.js` - Editor System
- **New Functions Added**:
  - `enableReferenceEditing()` / `disableReferenceEditing()`
  - `handleAddReference()` - Creates new reference item
  - `handleDeleteReference()` - Removes and renumbers references
  - `updateCitationsInDocument()` - Syncs citation numbers after deletion
  - `setupAtMentionSystem()` / `cleanupAtMentionSystem()`
  - `handleAtKeyup()` - Detects '@' trigger
  - `showMentionDropdown()` - Creates and positions popup
  - `navigateMentionDropdown()` - Keyboard navigation
  - `selectCurrentMention()` / `insertCitation()` - Citation insertion
  - `closeMentionDropdown()` - Cleanup
  - `setupCitationClickHandlers()` / `removeCitationClickHandlers()`
  - `handleCitationClick()` - Scroll and highlight

- **Modified Functions**:
  - `enable()` - Added `document.body.classList.add('edit-mode')`, calls reference/mention/citation setup
  - `disable()` - Added `document.body.classList.remove('edit-mode')`, cleanup
  - `handleTextEdit()` - Now uses `innerHTML` for elements with `data-ref-content="true"`

- **Exported APIs**:
  - `setupCitationClickHandlers` - For section renderer initialization
  - `removeCitationClickHandlers` - For cleanup

#### `js/section-renderer.js`
- `reinitializeComponents()` now calls `EditorSystem.setupCitationClickHandlers()`
- Ensures citation clicks work in both view and edit modes

#### `css/input.css`
- Added all reference system styles (see CSS section above)
- Built with Tailwind CSS: `npx tailwindcss -i css/input.css -o css/styles.css --minify`

## User Workflows

### Adding a Reference (Edit Mode)

1. Switch to Edit mode (pencil icon in navbar)
2. Scroll to footer Reference section
3. Click the "+" (Add Reference) button
4. New reference appears with placeholder text
5. Edit the reference text inline
6. Reference auto-saves on blur

### Citing a Reference in Content (Edit Mode)

1. Click into any editable text field (title, description, etc.)
2. Position cursor where citation should appear
3. Type '@' character
4. Reference dropdown appears showing all available references
5. Use arrow keys or mouse to select desired reference
6. Press Enter or click to insert citation
7. Citation appears as blue superscript (e.g., `[1]`)
8. Content auto-saves with embedded citation HTML

### Navigating to a Reference (View or Edit Mode)

1. Find a citation in the content (blue superscript number)
2. Click the citation
3. Page smoothly scrolls to the footer reference section
4. Target reference highlights with cyan glow animation
5. Highlight fades after 2 seconds

### Deleting a Reference (Edit Mode)

1. In Edit mode, hover over a reference in the footer
2. "x" delete button appears on the right
3. Click delete button
4. Confirm deletion in dialog
5. Reference is removed
6. All remaining references are renumbered (1, 2, 3, ...)
7. All citations in the document update to new numbers
8. Citations pointing to deleted reference are removed
9. Page re-renders with updated references and citations

## Technical Details

### ContentEditable + HTML Preservation

**Challenge**: Standard contentEditable elements with `textContent` stripping would remove citation `<sup>` tags.

**Solution**:
- Added `data-ref-content="true"` marker to elements that can contain citations
- Modified `handleTextEdit()` to check for this marker
- Uses `innerHTML` instead of `textContent` for marked elements
- Material JSON stores HTML strings for citation-containing fields
- Templates render stored HTML directly (trusted content)

### Reference Renumbering Algorithm

When a reference is deleted:
1. Remove item from `items` array by ID
2. Loop through remaining items and assign sequential IDs: 1, 2, 3...
3. Query all `.ref-cite` elements in DOM
4. For each citation:
   - If `data-ref-id` matches deleted ID: remove element
   - If `data-ref-id` > deleted ID: decrement by 1, update text content
5. Update material paths for all `[data-ref-content]` elements with new HTML
6. Persist to material in memory
7. Re-render to reflect changes

### Caret Position Detection

**For '@' mention dropdown positioning**:
1. Get current selection via `window.getSelection()`
2. Extract `Range` object from selection
3. Call `range.getBoundingClientRect()` for pixel coordinates
4. Position dropdown at `rect.left, rect.bottom + 5px`
5. Dropdown repositions on every keyup event while '@' is active

### Citation Insertion DOM Manipulation

**Process**:
1. Locate '@' character in text node before cursor
2. Split text node at '@' position
3. Create new `<sup class="ref-cite">` element
4. Insert citation element after first text fragment
5. Create new text node for content after cursor
6. Insert after citation element
7. Set cursor position after citation (or at start of after-text)
8. Trigger blur event to save changes

### Event Delegation for Performance

**Citation Click Handler**:
- Single event listener on `document` instead of individual citations
- Uses `event.target.closest('.ref-cite')` to detect clicks
- Works for dynamically added citations
- No need to rebind after re-renders
- Automatically handles citations in all sections

## Benefits

### For Content Authors
- **Easy Citation Management**: Add/delete references without manual renumbering
- **Quick Reference Insertion**: '@' mention system faster than manual HTML editing
- **Visual Feedback**: Click citations to verify they point to correct references
- **Safe Deletion**: System automatically updates all dependent citations

### For Readers
- **Quick Navigation**: One-click jump from citation to full reference
- **Visual Highlighting**: Immediately see which reference was cited
- **Smooth Experience**: Animated scroll and highlight feels professional
- **Works Everywhere**: Citations clickable in all sections (hero, features, etc.)

### For Developers
- **Extensible**: Easy to add citation styles (APA, MLA, Chicago)
- **Maintainable**: Clear separation of concerns (template, editor, renderer)
- **Performant**: Event delegation and efficient DOM updates
- **Type-Safe**: HTML preservation allows rich formatting in references

## Known Limitations

1. **No Citation Formats**: Currently just numbered citations, no author-year or footnote styles
2. **No Duplicate Detection**: Can insert multiple citations to same reference
3. **No Citation Context**: No tooltip preview of reference text on citation hover
4. **Manual Reference Order**: References stay in the order they were added, no alphabetical sorting
5. **Single-Character Trigger**: Only '@' is supported, no alternative triggers like '[' or '^'

## Future Enhancements (Not Implemented)

- Multiple citation styles (IEEE, APA, MLA, Chicago)
- Citation context tooltip on hover
- Bulk reference import from BibTeX/EndNote
- Automatic alphabetical sorting of references
- In-text citation with author names (not just numbers)
- Footnotes as an alternative to endnotes
- Cross-reference tracking (e.g., "see also [2]")
- Reference search/filter in '@' dropdown
- Citation statistics (most cited references)
- Export references as bibliography file

## Testing Checklist

- [x] Add new reference with "+" button
- [x] Delete reference with "x" button and confirm renumbering
- [x] Type '@' in content field and see dropdown
- [x] Navigate dropdown with arrow keys
- [x] Insert citation with Enter key
- [x] Insert citation by clicking dropdown item
- [x] Close dropdown with Escape key
- [x] Click citation to scroll to reference
- [x] Verify highlight animation on target reference
- [x] Citations work in view mode
- [x] Citations work in edit mode
- [x] Multiple citations in same paragraph
- [x] Citation preservation after page re-render
- [x] Reference text editing preserves embedded citations
- [x] Deleted reference removes orphaned citations
- [x] Export/import material preserves citation HTML
- [x] Edit-mode-only elements hidden in view mode
- [x] Edit-mode-only elements visible in edit mode

## Files Modified Summary

### Created
- `Document/Log/v0.4_reference_citation_system.md` (this file)

### Modified
- `material.json` - Changed footer.reference structure to items array
- `js/templates.js` - Rewrote footer template with dynamic reference list
- `js/editor.js` - Added reference editing, '@' mention system, citation click handler
- `js/section-renderer.js` - Added citation click handler initialization
- `css/input.css` - Added reference system styles
- `css/styles.css` - Rebuilt from input.css with new styles

## Migration Notes

**Existing Sites**:
- Old `material.json` with `reference.body` will automatically convert to `items` array
- No manual data migration required
- First load converts format, subsequent saves use new format

**Offline Edits**:
- Export before upgrading to preserve exact JSON format
- After upgrade, import will validate and accept both old and new formats
- Offline drafts in localStorage will be migrated on first load

**Online Mode**:
- MySQL database will receive new reference structure on first save
- Old reference body content converts to first item in array
- No database schema changes required (still JSON blob storage)

### 2026-02-09 Hotfix 0.4.1 (Reference Add Crash)

**Issue observed**:
- Clicking `+ Add Reference` threw runtime error:
  - `Uncaught TypeError: items.push is not a function`
- Root cause was malformed/legacy `footer.reference.items` state from old draft/import data (non-array).

**Fix implemented**:
- Updated `js/editor.js`:
  - Added `ensureReferenceItemsArray(material)` normalization helper.
  - `handleAddReference()`, `handleDeleteReference()`, and `showMentionDropdown()` now normalize data before use.
  - Handles all legacy shapes safely: `body` string, single object, plain string, missing fields.
- Updated `js/templates.js`:
  - Footer rendering now also normalizes malformed `reference.items` at render time.
  - Safe fallback for missing/invalid `id` and `text`.
- Added idempotent guard for citation click binding to avoid duplicate delegated listeners after rerenders.

**Result**:
- `+ Add Reference` works reliably even when local/offline historical drafts contain old data formats.
- `@` reference dropdown also remains stable under malformed reference data.

### 2026-02-09 Hotfix 0.4.2 (@ Dropdown Not Showing)

**Issue observed**:
- Typing `@` in some editable fields did not show the reference dropdown.
- This happened when caret container was not a plain text node (e.g., empty block, inline tags, post-citation cursor positions).

**Fix implemented**:
- Updated `js/editor.js`:
  - Reworked trigger detection to use full text-before-caret range analysis within the current editable element.
  - Added direct key trigger for `@` key press.
  - Refactored citation insertion to work with generic ranges, not only text-node caret states.
  - Added best-effort removal of the just-typed `@` before inserting citation.
  - Ensured edited fields with inserted citations are marked `data-ref-content="true"` so blur-save keeps HTML (`<sup>`) intact.

**Result**:
- `@` dropdown appears consistently across normal editing scenarios.
- Inserted citations no longer get stripped on save due to plain-text fallback.

## Conclusion

Version 0.4 adds a professional academic citation system that enhances the website's credibility for educational content. The '@' mention interface provides a modern, intuitive way to cite sources, while the click-to-jump navigation creates a seamless reading experience. The system integrates cleanly with the existing CMS architecture and maintains full backward compatibility.
