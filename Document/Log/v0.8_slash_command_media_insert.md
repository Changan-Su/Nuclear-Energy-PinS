# v0.8 斜杠命令与媒体插入功能

**实现日期**: 2025-02-15

## 功能概述

为所有 detail 编辑区域添加了 '/' 命令触发机制,支持快速插入图片和视频,并可以通过拖拽调整大小。

## 核心功能

### 1. '/' 命令触发系统 (类似 @ mention)

在所有包含 `data-material` 且 `contenteditable="true"` 的 detail 编辑区域:
- 输入 `/` 字符自动弹出命令菜单
- 支持键盘导航 (↑↓ 箭头键、Enter 确认、Esc 取消)
- 命令菜单包含:
  - **插入图片**: 上传本地图片文件
  - **插入视频**: 上传本地视频文件

**实现位置**: `js/editor.js` (2722行起)
- `setupSlashCommandSystem()`: 初始化斜杠命令系统
- `handleSlashKeyup()`: 处理斜杠键入事件
- `showCommandDropdown()`: 显示命令下拉菜单
- `executeCommand()`: 执行选中的命令

### 2. 媒体上传功能

**上传流程**:
1. 用户选择 "插入图片" 或 "插入视频" 命令
2. 触发浏览器原生文件选择器
3. 文件上传到服务器 `/upload` 端点
4. 返回文件URL
5. 将媒体块插入到 detail 内容末尾

**实现函数**:
- `triggerMediaUpload()`: 触发文件上传
- `uploadMediaFile()`: 执行文件上传请求
- `insertMediaBlock()`: 将上传的媒体插入到 material 数据中

### 3. detailBlocks 数据结构

引入新的富文本块数组结构,取代原有的简单字符串 `detail` 字段:

```javascript
// 旧格式
{
  detail: "这是一段文本内容..."
}

// 新格式
{
  detailBlocks: [
    { type: 'text', content: '这是一段文本内容...' },
    { type: 'image', url: '/uploads/image.jpg', width: 600 },
    { type: 'video', url: '/uploads/video.mp4', width: 800 }
  ]
}
```

**向后兼容**:
- 如果 `detailBlocks` 不存在,渲染时会自动使用旧的 `detail` 字符串
- 首次插入媒体时,会自动将 `detail` 字符串迁移为 `detailBlocks` 数组

### 4. 媒体块渲染

**实现位置**: `js/templates.js`

新增 `renderDetailBlocks()` 函数,支持三种块类型:
- **text块**: 普通文本段落
- **image块**: 图片,居中显示,可调整宽度
- **video块**: 视频,居中显示,可调整宽度,包含播放控件

每个媒体块包含:
- 居中布局容器 (`.detail-media-block`)
- 可调宽度包裹器 (`.detail-media-wrapper`)
- 媒体内容 (图片/视频)
- 拖拽调整把手 (`.detail-media-resize-handle`)
- 删除按钮 (`.detail-media-delete`)

**修改的渲染函数**:
- `renderDetailContent()`: 支持 `detailBlocks` 和 `detailBlocksPath` 参数
- `renderFlipWrapper()`: 传递 `detailBlocks` 到 detail 内容渲染

**更新的模板**:
- `tabbedContentTemplate()` (Highlights)
- `textImageLeftTemplate()` (Safety, Innovation)
- `textImageRightTemplate()` (Economy)
- `accordionTemplate()` (Closer Look)

### 5. 拖拽调整大小功能

**实现位置**: `js/editor.js` (3000行起)

**交互流程**:
1. 鼠标悬停在媒体块上,显示右侧调整把手
2. 拖拽把手左右移动
3. 实时更新媒体块宽度 (限制在 200px - 1200px)
4. 松开鼠标,自动保存新宽度到 material.json

**实现函数**:
- `initMediaResizeHandlers()`: 初始化调整大小监听器
- `handleResizeStart()`: 开始拖拽
- `handleResizeMove()`: 拖拽过程中更新宽度
- `handleResizeEnd()`: 完成拖拽,保存宽度
- `updateMediaBlockWidth()`: 更新 material 中的宽度数据

### 6. 媒体块删除功能

在编辑模式下,媒体块右上角显示删除按钮:
- 点击删除按钮移除对应的 media block
- 自动更新 `detailBlocks` 数组
- 重新渲染 detail 内容

**实现函数**: `handleMediaDelete()`

### 7. CSS 样式

**新增样式** (`css/styles.css`, 2180行起):

```css
/* 命令下拉菜单 */
.command-dropdown
.command-dropdown-item
.command-dropdown-item-icon
.command-dropdown-item-content

/* 媒体块 */
.detail-media-block
.detail-media-wrapper
.detail-media-content
.detail-media-resize-handle
.detail-media-delete

/* 上传指示器 */
.upload-indicator
.upload-spinner
```

## 使用场景

### 适用的 detail 区域

所有包含以下特征的编辑区域都支持 '/' 命令:
- 具有 `data-material` 属性
- 属性值包含 "detail" 路径
- `contenteditable="true"` (编辑模式)

包括但不限于:
- Highlights (tabbed-content) 的每个 tab 的 detail
- Features (card-grid) 的每个卡片的 detail
- Safety, Innovation, Economy (text-image) 的 detail
- Closer Look (accordion) 的每个 feature 的 detail
- Interactive Details 的每个 item 的 detail

### 用户操作流程

1. 进入编辑模式
2. 点击任意 detail 内容区域
3. 输入 `/` 触发命令菜单
4. 选择 "插入图片" 或 "插入视频"
5. 在文件选择器中选择文件
6. 等待上传完成
7. 图片/视频自动插入到 detail 末尾
8. 鼠标悬停在媒体块上,拖拽右侧把手调整宽度
9. 保存修改

## 技术细节

### 数据流

```
用户输入 '/'
  ↓
显示命令菜单
  ↓
选择命令 (image/video)
  ↓
触发文件上传
  ↓
上传到 /upload 端点
  ↓
获取文件 URL
  ↓
更新 material.detailBlocks
  ↓
重新渲染 detail 内容
  ↓
初始化调整大小监听器
```

### 与现有功能的集成

1. **@ 引用系统**: 斜杠命令系统与 @ 引用系统并行工作,互不干扰
2. **编辑模式**: 斜杠命令只在编辑模式 (`edit-mode` class) 下激活
3. **材料保存**: 媒体块数据自动保存到 material.json
4. **离线导出**: 支持导出到本地文件夹

### 初始化时机

在 `enable()` 函数中:
```javascript
setupAtMentionSystem();      // @ 引用系统
setupSlashCommandSystem();   // 斜杠命令系统
setupCitationClickHandlers(); // 引用点击处理
initMediaResizeHandlers();   // 媒体调整大小
```

在 `disable()` 函数中:
```javascript
cleanupAtMentionSystem();
cleanupSlashCommandSystem();
removeCitationClickHandlers();
```

## 已知限制

1. **插入位置**: 目前只能在 detail 文本末尾插入媒体,不能在文本中间插入
2. **编辑文本块**: 插入媒体后,原有 detail 文本会变成 text 块,但暂不支持直接编辑 text 块内容
3. **文件大小**: 未限制上传文件大小,需要服务器端配置
4. **拖拽方向**: 只支持左右拖拽调整宽度,不支持调整高度

## 未来改进方向

1. 支持在光标位置插入媒体 (需要更复杂的富文本编辑器)
2. 支持编辑 text 块内容
3. 支持更多媒体类型 (音频、PDF 等)
4. 支持从 URL 插入媒体
5. 添加图片裁剪和编辑功能
6. 支持拖拽排序媒体块

## 测试建议

1. ✅ 在不同 detail 区域测试 '/' 命令触发
2. ✅ 测试上传不同格式的图片 (jpg, png, gif)
3. ✅ 测试上传不同格式的视频 (mp4, webm)
4. ✅ 测试拖拽调整媒体大小
5. ✅ 测试删除媒体块
6. ✅ 测试保存和重新加载
7. ✅ 测试向后兼容 (旧的 detail 字符串格式)
8. ✅ 测试离线导出功能

## 相关文件

- `js/editor.js`: 斜杠命令系统、媒体上传、调整大小
- `js/templates.js`: detailBlocks 渲染、模板更新
- `css/styles.css`: 命令菜单、媒体块样式
- `server/routes/upload.js`: 文件上传端点 (已有)

## 内容更新：docs/MSR 页面填充（来自 MSR Write Up.docx）

**实现日期**: 2026-02-15

将 `docs` 站点的 MSR（`interactive-details` 模板）从占位内容替换为文档原文，并按 **Section / Key Sentences / Details** 三段式组织内容，尽可能保留原句与段落结构。

- **数据更新位置**: `docs/material.json` 的 `index.MSR`
- **离线回退一致性**: 同步更新 `docs/index.html` 内嵌的 `window.__PRELOADED_MATERIAL__` 对应 `MSR` 块（避免 `file://` 下 fetch 失败时内容不一致）

MSR Items 拆分为：
- Summary for Main Page
- What are MSRs?
- How MSRs work
- Fuel recycling / cleaning
- Alternative fuel sources
- Increased passive safety
- Reduced / less dangerous waste and byproducts
- Challenges surrounding MSRs
- References

### 修正：按文档 1/2/3 Section 收敛为 3 项

根据 `MSR Write Up.docx` 中明确标注的 1/2/3 Section，将 MSR 的 `interactive-details` 左侧目录收敛为 **3 个 items**：
- **1. What are MSRs?**（合并 Summary + 定义 + 分类）
- **2. How MSRs Work**（Similarities/Differences）
- **3. Benefits and challenges**（合并 benefits 各子段 + challenges + references）

实现方式：更新 `docs/material.json` 与 `docs/index.html` 内嵌回退数据中的 `index.MSR.items`，由多条 Topic 合并为 3 条 Section，内容尽量保持原文句子与段落顺序。

## v0.9 Text Image Left 模板增强：FLIP 变形动画与自然尺寸图片

**实现日期**: 2026-02-15

### 功能概述

为 `text-image-left` 模板（目前应用于 `safety` 和 `innovation` sections）添加两项增强功能：
1. **Apple 风格的 FLIP 变形切换动画**：section 切换时，标题以平滑的缩放+位移动画从当前按钮位置变形到目标按钮位置
2. **Detail 视图自然尺寸图片显示**：点击 "Learn more" 后，detail banner 图片按上传原始尺寸显示（不拉伸），通过 `detailImageShrinkRatio` 参数控制最大约束

### 1. FLIP 变形切换动画

**实现位置**: `Example/js/section-renderer.js` - `initializeTextImageLeftSwitchers()` 函数中的 `switchToIndex()`

**动画原理** (First, Last, Invert, Play):
1. **Phase 1 (Shrink out)**: 
   - 捕获当前标题元素的 bounding rect 和当前按钮的 bounding rect
   - 计算缩放比例 (按钮宽高 / 标题宽高) 和位移 delta
   - 应用 CSS transform，将标题缩小并平移到当前按钮位置（~350ms cubic-bezier）
   - 同时淡出描述文本（~250ms）

2. **Phase 2 (Swap content)**:
   - 更新标题和描述的 `textContent`
   - 更新 `data-material` 属性
   - 更新图片源（视频或背景图）
   - 更新按钮激活状态

3. **Phase 3 (Expand in)**:
   - 捕获新按钮的 bounding rect
   - 无过渡地将标题定位在新按钮处（缩小状态）
   - 使用 `requestAnimationFrame` 触发动画，将标题还原到原始尺寸和位置（~350ms cubic-bezier）
   - 同时淡入描述文本（~350ms）

4. **Image cross-fade**: 保持现有的图片淡入淡出动画，与标题变形并行运行

**CSS 支持** (`Example/css/styles.css`):
```css
.til-title {
  transform-origin: left top;
}
.til-description {
  transform-origin: left top;
}
.til-title--morphing,
.til-description--morphing {
  will-change: transform, opacity;
}
```

**效果**: 
- 标题像"液态"一样从一个按钮位置流动到另一个按钮位置
- 描述在切换时优雅地淡入淡出
- 图片在背景平滑交叉淡化
- 整体视觉连续性强，符合 Apple 产品的动画风格

### 2. Detail 视图自然尺寸图片

**需求**: 点击 "Learn more details" 后，右侧 detail banner 图片不再拉伸填充整个容器，而是按照上传时的原始像素尺寸显示，`detailImageShrinkRatio` 参数作为最大宽高约束。

**实现位置**:

#### 模板层 (`Example/js/templates.js`)

修改 `renderDetailMedia()` 函数:
- 新增参数 `useNaturalSize` 和 `shrinkRatio`
- 当 `useNaturalSize` 为 `true` 且 `shrinkRatio` 存在时：
  - 渲染 `<img>` 标签而非 `background-image` div
  - 图片包裹在 `.detail-banner-media--natural` 容器中
  - `<img>` 添加 `.detail-banner-img-natural` 类
  - 通过 CSS 变量 `--detail-banner-shrink-ratio` 控制最大宽度

修改 `renderDetailContent()` 函数:
- 检测 `bannerShrinkRatio` 参数是否存在
- 如果存在，设置 `useNaturalSize = true`
- 将标志传递给 `renderDetailMedia()`

**数据流**:
```
textImageLeftTemplate
  ↓ 为每个 item 设置 detailImageShrinkRatio
  ↓ 构建 detail panels
  ↓ 调用 renderDetailContent({ bannerShrinkRatio })
  ↓ 检测到 shrinkRatio → useNaturalSize = true
  ↓ renderDetailMedia(..., useNaturalSize, shrinkRatio)
  ↓ 渲染 <img class="detail-banner-img-natural">
```

#### 样式层 (`Example/css/styles.css`)

新增样式:
```css
.detail-banner-media--natural {
  height: auto;
  min-height: 0;
  max-height: none;
  display: flex;
  justify-content: center;
  align-items: center;
  background: none;
  border: none;
}

.detail-banner-img-natural {
  display: block;
  max-width: calc(var(--detail-banner-shrink-ratio, 60) * 1%);
  max-height: 50vh;
  height: auto;
  width: auto;
  object-fit: none;  /* 不缩放，保持原始尺寸 */
  border-radius: 12px;
}
```

**效果**:
- 图片以原始上传尺寸显示，不会被拉伸或裁切
- `detailImageShrinkRatio` (默认 60) 控制图片最大占据视口宽度的百分比
- 图片居中显示在 detail banner 区域
- 如果图片小于约束尺寸，按原始尺寸显示；如果超过约束，按比例缩小到约束范围内

### 3. 文件同步

所有修改同步到 `docs/` 目录:
- `docs/css/styles.css` ← `Example/css/styles.css`
- `docs/js/templates.js` ← `Example/js/templates.js`
- `docs/js/section-renderer.js` ← `Example/js/section-renderer.js`

### 技术要点

#### FLIP 动画关键

1. **getBoundingClientRect()**: 获取元素当前在视口中的精确位置
2. **transform 优化**: 使用 `translate` + `scale` 而非 `width`/`height`，由 GPU 加速
3. **will-change 声明**: 提前告知浏览器哪些属性将改变，优化渲染性能
4. **requestAnimationFrame**: 确保在浏览器重绘前应用 transform，避免闪烁
5. **cubic-bezier 缓动**: `cubic-bezier(0.4, 0.0, 0.2, 1)` 产生平滑的加速-减速效果

#### Natural Size 实现关键

1. **条件渲染**: 仅对 TIL 模板使用自然尺寸模式，其他模板保持 `background-image` 填充模式
2. **CSS 变量传递**: `--detail-banner-shrink-ratio` 在 inline style 设置，CSS 通过 `calc()` 使用
3. **object-fit: none**: 关键属性，确保图片不被浏览器自动缩放
4. **向后兼容**: 旧的 card-grid 和 tabbed-content 模板不传 `bannerShrinkRatio`，继续使用 `background-image` 模式

### 用户体验改进

**Before**:
- Section 切换：标题和描述瞬间替换（无动画）
- Detail 图片：拉伸填充整个横幅区域，可能变形

**After**:
- Section 切换：标题如液体般从一个按钮"流动"到另一个按钮，视觉连贯流畅
- Detail 图片：保持原始比例和尺寸，图片质量不受损失，用户可通过 shrink ratio 控制显示大小

### 相关文件

- `Example/js/section-renderer.js` (line 518-680): FLIP 变形动画实现
- `Example/js/templates.js` (line 49-84, 369-399): 自然尺寸图片渲染
- `Example/css/styles.css` (line 3501-3585): 变形动画和自然尺寸图片样式
- `docs/js/`, `docs/css/`: 镜像副本

---

## v1.0 Text Image Left 模板重新设计：去除翻转，同面布局切换

**日期**: 2026-02-15  
**修改类型**: 重新设计核心交互，移除 flip-card 机制

### 背景

用户反馈了两个主要问题：
1. **Section 切换按钮不显示**：当前 safety section 只有单一数据结构（没有 `items` 数组），而之前的实现要求 `items` 数组才能显示切换按钮
2. **Detail 展开效果不符合预期**：用户期望的是同一个面的布局重组（右侧图片缩小移到右边，左侧显示 detail 内容），而不是 flip 翻转到背面

### 核心改动

#### 1. 完全移除 Flip Card 机制

**Before (v0.9)**:
- 使用 `.flip-card` 结构，包含 `.flip-card-front` 和 `.flip-card-back`
- 点击"Learn more"触发 Y 轴 180° 翻转
- Detail 内容在背面显示

**After (v1.0)**:
- 使用 `.til-container` 扁平结构，无 front/back 分层
- 左侧区域包含两个状态层：
  - `.til-collapsed-content`: 标题/描述/CTA 按钮（collapsed 状态显示）
  - `.til-detail-content`: Detail 内容（expanded 状态显示）
- 右侧区域：图片容器，宽度根据状态动态调整
- 状态切换通过 `opacity` 和 `pointer-events` 控制可见性

#### 2. 同面布局切换动画

**Collapsed → Expanded (点击 Learn more)**:
1. 左侧 collapsed content 淡出 (`opacity: 0`)
2. 右侧图片区域宽度缩小到 `shrinkRatio%`（默认 60%）
3. 延迟 300ms 后，左侧 detail content 淡入 (`opacity: 1`)

**Expanded → Collapsed (点击 Close)**:
1. 左侧 detail content 淡出
2. 右侧图片区域宽度恢复到 `calc(100% - 500px - 80px)`
3. 延迟 300ms 后，左侧 collapsed content 淡入

**关键 CSS**:
```css
.til-right-area {
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.til-collapsed-content,
.til-detail-content {
  transition: opacity 0.3s ease;
}
```

#### 3. Section 切换保留 FLIP 变形动画

Section 按钮切换的标题变形动画**保持不变**，继续使用 v0.9 实现的 FLIP 技术：
- 标题从当前按钮位置缩小消失
- 内容更新
- 标题从新按钮位置放大出现

这一动画与 detail 展开/收起动画**独立**，可以在任何状态下执行。

#### 4. 支持单 item 和多 item Section

**模板兼容性改进**:
- 检测 `data.items` 是否为数组
- 如果有 `items`，material 路径为 `${sectionId}.items.0.xxx`
- 如果无 `items`（如 safety），material 路径为 `${sectionId}.xxx`
- 切换按钮仅在 `items.length > 1` 时显示

**示例**:
- `safety` section: 单一结构，无切换按钮，支持 detail 展开
- `innovation.items[]`: 多 item 结构，显示切换按钮，每个 item 独立的 detail 内容

### 技术实现

#### templates.js 变更

**关键变量**:
```javascript
const hasItemsArray = Array.isArray(data?.items) && data.items.length > 0;
const materialPrefix = hasItemsArray ? `${sectionId}.items.0` : sectionId;
```

**新模板结构**:
- 移除 `flip-card`, `flip-card-inner`, `flip-card-front/back` 层级
- 使用 `data-til-detail-state="collapsed"` 跟踪展开状态
- 添加 `data-til-has-items` 属性用于调试
- 左右区域采用 `absolute` 定位，便于独立控制尺寸和位置

#### section-renderer.js 变更

**新增函数逻辑**:
1. **expandDetail()**: 展开 detail 视图
   - 淡出 collapsed content
   - 缩小 right area 到 `shrinkRatio%`
   - 淡入 detail content
   - 渲染 LaTeX（如果有）

2. **collapseDetail()**: 收起 detail 视图
   - 淡出 detail content
   - 恢复 right area 宽度
   - 淡入 collapsed content

3. **switchToIndex()**: Section 切换（保留 FLIP 动画）
   - 更新 title, description, imageLabel
   - 更新 detail content (detailTitleEl, detailTextEl)
   - 更新图片或视频
   - 更新按钮 active 状态

**事件监听**:
- `[data-til-learn-more]` → `expandDetail()`
- `[data-til-close]` → `collapseDetail()`
- `.til-switcher-btn` → `switchToIndex(targetIndex)`

#### styles.css 变更

**新增样式**:
```css
/* TIL container layout */
.til-container {
  position: relative;
}

.til-left-area {
  z-index: 2;  /* 确保左侧内容在右侧图片上方 */
}

.til-right-area {
  z-index: 1;
  transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.til-collapsed-content,
.til-detail-content {
  transition: opacity 0.3s ease;
}

.til-image-wrapper {
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}
```

### 用户体验改进

**Before (v0.9)**:
- 点击 Learn more：整个卡片 Y 轴翻转 180°，背面显示 detail
- 视觉割裂感强，front 和 back 是两个独立世界

**After (v1.0)**:
- 点击 Learn more：右侧图片优雅地缩小到一边，左侧内容平滑切换
- 所有元素在同一平面，空间感连贯，类似 Apple 产品页面的布局切换
- Section 切换时，标题仍保留"液体流动"的 FLIP 变形动画

### 文件同步

所有修改同步到 `docs/` 目录:
- `docs/css/styles.css` ← `Example/css/styles.css`
- `docs/js/templates.js` ← `Example/js/templates.js`
- `docs/js/section-renderer.js` ← `Example/js/section-renderer.js`

### 相关文件

- `Example/js/templates.js` (line 833-953): TIL 模板重新设计
- `Example/js/section-renderer.js` (line 518-782): Detail 展开/收起 + Section 切换
- `Example/css/styles.css` (line 3501-3565): TIL 布局切换样式
- `docs/js/`, `docs/css/`: 镜像副本

---

## v1.1 Renewable Grid 紧急恢复（卡片内容/设置/图片）

**日期**: 2026-02-15  
**触发原因**: 用户反馈 grid card 区域的 Renewable 内容、配置与图片丢失

### 问题定位

- `index.html` 内嵌数据仍保留完整 `features`（`Renewables – Lucy` + 5 张卡片 + references + flip 设置 + 图片路径）。
- 实际渲染数据源 `material.json` 与 `docs/material.json` 的 `index.features` 被后续版本替换为核能三卡片版本。
- 根目录 `uploads/` 目录缺失，导致站点页面图片路径 `uploads/*.png` 404。

### 恢复方案

1. **数据恢复（内容 + 设置）**
   - 将 `index.html` 中完整的 Renewable `features` 块回填到：
     - `material.json`
     - `docs/material.json`
   - 恢复字段包括：
     - `headline/subheadline`
     - 5 张 cards 的 `title/description/detail/references`
     - `cta/flipEnabled/flipDirection/detailEndImage`
     - `image` 与 `position.scale`

2. **图片恢复**
   - 确认 `docs/uploads/` 中 5 张 Renewable 图片仍在。
   - 新建根目录 `uploads/`，并复制图片到根目录，恢复主站图片可见性：
     - `media-k8uxap-7.png`
     - `media-ftntjq-8.png`
     - `media-ni5a27-9.png`
     - `media-9fpp0x-10.png`
     - `media-f4odw4-11.png`

### 结果

- Renewable Grid 的卡片文本、交互配置、参考文献和图片路径已恢复。
- 主站与 `docs` 两套 material 数据重新对齐到 Renewable 版本。
- 根目录图片资源恢复，可直接用于 `uploads/...` 路径渲染。

---

## v1.2 Text Image Left 模板：总标题、Details 布局联动与图片独立性

**日期**: 2026-02-15  
**修改类型**: 功能增强与问题修复

### 背景

在 v1.0 同面布局基础上，用户进一步提出：
1. TIL 需要类似 Card Grid 的**总标题和描述**，显示在整体上方，与 section 内容无关
2. Details 界面下，图片大小改变后，**左侧文字区域应联动变宽**，中间不空出
3. **每个 section 的图片应独立**，切换 section 后不应显示同一张图
4. Details 界面图片应**可独立调整大小**，且以**原生比例**显示（不自动填充）

### 1. TIL 总标题与描述（Headline / Subheadline）

**需求**: 在 TIL section 最上方显示独立的大标题和描述，横跨整宽，不挤在左侧内容区。

**实现**:
- **数据**: 在 `material.json` 中为 `safety`、`innovation` 增加 `headline`、`subheadline` 字段
- **模板** (`js/templates.js`): 在 `<section>` 内、`.til-container` 之前增加 `.til-headline-wrapper`
  - 居中、全宽
  - `headline`: 56px 主标题，`data-material="${sectionId}.headline"`
  - `subheadline`: 21px 副标题，`max-w-[980px] mx-auto`，`data-material="${sectionId}.subheadline"`
  - 仅当 `data.headline` 存在时渲染该块
- **间距**: headline 区域与下方主内容容器 `mb-16`（64px）

**效果**: 每个 TIL section（如 Safety、Innovation）在顶部有独立的总标题和描述，与 Card Grid 的 "Better by every measure." 风格一致。

### 2. Details 界面布局联动（左宽随右图变化）

**需求**: 仅在 **detail 状态**下，当右侧图片容器宽度改变时，左侧内容区域自动变宽，占满剩余空间，中间保持固定间距（60px），不空出。

**实现**:
- **间距统一**: 左右区域间距由 80px 改为 **60px**（`templates.js`、`section-renderer.js` 中 `calc(100% - 500px - 60px)`）
- **expandDetail()** (`js/section-renderer.js`):
  - 在设置 `rightWrapper.style.width = shrinkRatio%` 后，计算：
    - `containerWidth = container.offsetWidth`
    - `rightWrapperWidth = (containerWidth * shrinkRatio) / 100`
    - `leftAreaWidth = containerWidth - rightWrapperWidth - 60`
  - 设置 `leftArea.style.width = leftAreaWidth + 'px'`
- **collapseDetail()**: 恢复 `leftArea.style.width = '500px'`
- **拖拽 resize** (`js/editor.js` - `handleTILResizeMove`):
  - 每次更新 `rightWrapper.style.width` 时，同步计算并设置左侧宽度：
    - `leftAreaWidth = containerWidth - rightWrapperWidth - 60`
    - `leftArea.style.width = leftAreaWidth + 'px'`

**效果**: Collapsed 状态保持左 500px 固定；Detail 状态下，拖拽右侧 resize handle 时，左侧文字区域实时变宽/变窄，中间始终 60px 间距。

### 3. 每个 Section 图片独立显示

**问题**: 切换 section 后，右侧图片仍显示上一 section 的图，或进入 detail 后图片 URL 错误。

**原因**: `updateImageContent(item, targetIndex)` 更新了 `imageWrapper.style.backgroundImage`，但**未更新** `data-material-img`。进入 detail 时 `expandDetail()` 从 `data-material-img` 或 material 路径取图，路径未随当前 section 更新，导致取到错误或同一张图。

**修复** (`js/section-renderer.js` - `updateImageContent`):
- 在设置 `backgroundImage` 时，同时设置 `data-material-img` 为当前 section 的 material 路径：
  - 有 items 数组: `${sectionId}.items.${targetIndex}.images.main`
  - 无 items: `${sectionId}.images.main`
- 保留从 material 动态取 `imgUrl` 的逻辑（`getImageUrl(path, material)`），确保编辑器修改图片后切换 section 也能正确显示。

**效果**: 切换 Safety / Innovation 或同一 section 内不同 item 时，右侧图片与 detail 内图片均显示当前选中 section 的独立图片。

### 4. Details 界面图片：原生比例与可调大小

**需求**: Details 下图片以**原生比例**显示（不拉伸填充），且在编辑模式下可**拖拽调整**右侧图片容器大小。

**已有实现（保持并确认）**:
- **显示**: `expandDetail()` 内创建 `<img class="til-detail-natural-img">`，CSS 使用 `object-fit: contain`、`max-width/max-height: 90%`、居中，实现原生比例、不自动填充
- **可调大小**: 进入 detail 且在编辑模式时，`addTILResizeHandle(rightWrapper)` 在右侧添加 `.til-resize-handle`；`editor.js` 中 `enableTILDetailImageResize()` 注册全局 `mousedown/mousemove/mouseup`，在 `handleTILResizeMove` 中更新 `rightWrapper.style.width` 并联动左侧宽度
- **同步**: 修改需同时落到**根目录** `js/`、`css/`（端口启动的编辑界面使用根目录），并同步到 `docs/` 以便 docs 站点一致

**注意**: 若只改 `Example/` 或 `docs/` 而未改根目录，端口打开的前端编辑界面会仍是旧行为。开发时修改应直接在根目录进行，或完成后执行同步到根目录。

### 5. Card Grid 详情内容恢复

**问题**: 用户反馈 Card Grid（Benefits）区域“内容全没了”。

**原因**: Git 历史中较早版本（如 `b03207e`）的 `material.json` 里，`features.cards` 每项包含 `detail`、`flipEnabled`、`flipDirection` 等字段；后续版本中这些字段被删减，仅剩 `title`、`description`、`image`。

**修复**: 从 `git show b03207e:material.json` 中提取 `features.cards` 的完整项（含 `detail` 与 flip 配置），写回当前 `material.json` 的 `index.features.cards`。

**效果**: Card Grid 每张卡片的背面详情文案与翻转配置恢复，点击卡片可看到完整 detail 内容。

### 6. 文件同步与编辑界面

**原则**:
- **端口启动的编辑界面**加载的是项目**根目录**的 `index.html`、`js/*.js`、`css/*.css`，而不是 `Example/` 或 `docs/`。
- 任何对 TIL、Card Grid、editor 的修改，在完成后需确保**根目录** `js/`、`css/` 已更新；若在 `Example/` 或 `docs/` 下开发，需复制回根目录。

**本次涉及文件**:
- `js/templates.js`: TIL 总标题结构、右区域宽度 60px 间距
- `js/section-renderer.js`: headline/subheadline 数据、expand/collapse 左宽联动、updateImageContent 的 data-material-img、detail 自然图与 resize handle 调用
- `js/editor.js`: handleTILResizeMove 左宽联动、resize 调试日志
- `css/styles.css`: TIL 相关样式（如 detail 状态下左宽由 JS 控制）
- `material.json`: safety/innovation 的 headline/subheadline、features.cards 的 detail 恢复

**同步建议**: 根目录为源，同步到 `docs/` 时执行：  
`cp js/*.js docs/js/ && cp css/styles.css docs/css/ && cp material.json docs/material.json`（按需选择文件）。

### 技术要点小结

| 项目 | 实现要点 |
|------|----------|
| TIL 总标题 | 独立于左右分栏，section 顶部全宽居中，仅 detail 状态不变 |
| Details 左宽联动 | 仅 detail 状态，左宽 = 容器宽 - 右宽 - 60；collapse 时恢复 500px |
| Section 图片独立 | updateImageContent 同时更新 backgroundImage 与 data-material-img |
| Detail 图片 | 原生比例 img + object-fit: contain；resize handle 调右宽并联动左宽 |
| Card Grid 内容 | 从 Git 历史恢复 features.cards 的 detail 等字段 |
| 编辑界面 | 端口服务用根目录 js/css，修改后需保证根目录已更新 |

### 相关文件

- `js/templates.js`: TIL 模板结构、headline 块、60px 间距
- `js/section-renderer.js`: expandDetail/collapseDetail、updateImageContent、addTILResizeHandle
- `js/editor.js`: enableTILDetailImageResize、handleTILResizeStart/Move/End、左宽联动
- `css/styles.css`: .til-left-area、.til-detail-natural-img、detail 状态样式
- `material.json`: index.safety / index.innovation（headline/subheadline）、index.features.cards（detail 恢复）

---

## 2026-02-15: TIL Section Title 与 Learn More 按钮修复

### 问题描述

用户反馈 TIL section 存在两个显示问题：
1. **Title 内容过长时**：标题会超出区域外面，无法完全显示
2. **Learn More 按钮位置**：跟随文字滚动，用户希望移动到 description 下面并固定不滚动

### 修复方案

#### 1. Title 自适应字体大小

**实现方式**: 使用 CSS `clamp()` 函数实现响应式字体缩放

```css
.til-title {
  /* Auto-scale font size to fit */
  font-size: clamp(40px, 5vw, 64px);
  line-height: 1.05;
  /* Ensure title stays within container */
  width: 100%;
  max-width: 100%;
  overflow-wrap: break-word;
  word-break: break-word;
  hyphens: auto;
}
```

**效果**:
- 正常情况下保持 64px（5vw）字体大小
- 当屏幕较小或内容过长时，自动缩小至最小 40px
- 配合 `overflow-wrap` 和 `word-break` 确保长单词也能正常换行
- 避免了内容溢出容器的问题

#### 2. Learn More 按钮固定在底部

**HTML 结构调整** (`js/templates.js` 和 `docs/js/templates.js`):

修改前：
```html
<div class="til-collapsed-content ... justify-center" data-til-collapsed-content>
  <h2 class="til-title ...">Title</h2>
  <p class="til-description ...">Description</p>
  <button class="til-learn-more-btn ...">Learn more</button>
</div>
```

修改后：
```html
<div class="til-collapsed-content ... flex flex-col" data-til-collapsed-content>
  <div class="flex-1 flex flex-col justify-center overflow-y-auto">
    <h2 class="til-title ...">Title</h2>
    <p class="til-description ...">Description</p>
  </div>
  <button class="til-learn-more-btn ...">Learn more</button>
</div>
```

**CSS 样式** (`css/styles.css` 和 `docs/css/styles.css`):

```css
/* Learn More button - fixed at bottom of collapsed content */
.til-learn-more-btn {
  position: absolute;
  bottom: 40px;
  left: 0;
  z-index: 5;
}

/* TIL collapsed content visibility */
.til-collapsed-content {
  opacity: 1;
  pointer-events: auto;
  /* Create space for fixed learn more button at bottom */
  padding-bottom: 80px;
}
```

**效果**:
- Learn More 按钮固定在容器底部 40px 位置
- Title 和 Description 包裹在可滚动的 flex-1 容器中
- 当内容过长时，title/description 可以向上滚动，但按钮始终可见
- 按钮不会跟随文字一起滚动，保持在固定位置

#### 3. Description 文本优化

同时为 description 添加文本换行处理：
```css
.til-description {
  width: 100%;
  max-width: 100%;
  overflow-wrap: break-word;
  word-break: break-word;
}
```

### 涉及文件

| 文件 | 修改内容 |
|------|----------|
| `js/templates.js` | TIL collapsed-content 布局重构，增加内嵌 flex 容器 |
| `docs/js/templates.js` | 同步上述修改 |
| `css/styles.css` | 添加 title 自适应字体、learn-more-btn 固定定位、collapsed-content padding |
| `docs/css/styles.css` | 同步上述修改 |

### 技术要点

1. **响应式字体**: `clamp(min, ideal, max)` 可以让字体在不同屏幕尺寸下自适应，无需媒体查询
2. **Flexbox 布局**: 使用 flex-1 让内容区域占据剩余空间，按钮固定在底部
3. **绝对定位配合相对定位**: 按钮使用 absolute 定位，相对于父容器底部固定
4. **滚动容器**: 内容区域设置 `overflow-y-auto` 允许在内容过长时滚动

### 用户体验改进

- ✅ Title 内容再长也不会溢出，自动缩小字体保证完整显示
- ✅ Learn More 按钮始终可见且位置固定，无需滚动寻找
- ✅ 内容过长时可以滚动查看 title/description，但按钮不动
- ✅ 保持了原有的过渡动画和交互体验

---

## 2026-02-15: TIL Section 数据持久化修复

### 问题描述

用户反馈在前端编辑界面修改TIL section的内容后，切换section或保存时数据会丢失：
1. **文字内容丢失**: 修改title或description后，切换到其他TIL item再切换回来，修改的内容消失
2. **图片上传丢失**: 上传图片后切换section，图片没有保存到material.json

### 问题根因

在 `js/section-renderer.js` 的 `switchToIndex` 函数中（第794-891行）：

```javascript
// 问题代码
setTimeout(() => {
  // 直接从初始items数组读取数据，忽略了DOM中的编辑
  titleEl.textContent = item.title || '';
  descEl.textContent = item.description || '';
  // ...
}, 450);
```

**根本原因**:
1. `items` 数组是初始化时从 material 读取的静态数据
2. 切换section时直接用 `items[targetIndex]` 覆盖DOM，**完全忽略了用户在DOM中的编辑**
3. 编辑的内容虽然通过 `handleTextEdit` 保存到了 material，但切换前没有同步当前index的数据
4. 图片上传通过 `handleImageUpload` 保存，但切换时又被旧数据覆盖

### 修复方案

#### 1. 切换前保存当前数据

新增 `saveCurrentTILData()` 函数，在切换前保存当前index的所有修改：

```javascript
function saveCurrentTILData() {
  if (!material) return;
  
  // Capture snapshot for undo
  if (window.ModeManager && window.ModeManager.captureSnapshot) {
    window.ModeManager.captureSnapshot();
  }
  
  const hasItemsArray = container.getAttribute('data-til-has-items') === 'true';
  const currentItemPath = hasItemsArray ? `${sectionId}.items.${currentIndex}` : sectionId;
  
  // Save title, description, imageLabel from DOM
  const currentTitle = titleEl.textContent.trim();
  const currentDesc = descEl.textContent.trim();
  
  setNestedValue(material, `${pageKey}.${currentItemPath}.title`, currentTitle);
  setNestedValue(material, `${pageKey}.${currentItemPath}.description`, currentDesc);
  
  // Update material in memory and patch to server
  window.ModeManager.updateMaterialInMemory(material);
  
  console.log('[TIL] Saved current data for index:', currentIndex);
}
```

#### 2. 切换时读取最新数据

修改 `switchToIndex` 函数，从 material 重新读取目标index的数据：

```javascript
function switchToIndex(targetIndex) {
  // ✅ 切换前保存当前数据
  saveCurrentTILData();

  setTimeout(() => {
    // ✅ 从material重新读取最新数据
    const freshMaterial = getMaterial();
    let freshItem = item;
    if (hasItemsArray && freshMaterial[pageKey][sectionId]) {
      freshItem = freshMaterial[pageKey][sectionId].items[targetIndex];
    }
    
    // ✅ 使用最新数据更新DOM
    titleEl.textContent = freshItem.title || '';
    descEl.textContent = freshItem.description || '';
  }, 450);
}
```

### 工作流程

现在的数据流正确流转：

```
用户编辑 → blur事件 → handleTextEdit → 
  → updateMaterialInMemory → 
  → (online模式) patchMaterial to server
  
切换section → saveCurrentTILData → 
  → 保存当前index数据到material →
  → 从material读取目标index最新数据 →
  → 更新DOM显示
  
Save All → 
  → saveMaterial → 
  → 包含所有已保存的TIL数据
```

### 涉及文件

| 文件 | 修改内容 |
|------|----------|
| `js/section-renderer.js` | 在 `initializeTextImageLeftSwitchers` 中添加 `saveCurrentTILData` 函数；修改 `switchToIndex` 在切换前保存数据，切换后读取最新数据 |
| `docs/js/section-renderer.js` | 同步上述修改 |

### 技术要点

1. **时序控制**: 必须在切换动画开始前保存数据，确保数据不丢失
2. **双向同步**: DOM ↔ material 双向保持一致
3. **快照机制**: 每次保存前调用 `captureSnapshot` 支持undo/redo
4. **在线同步**: online模式下自动patch到服务器
5. **fresh data**: 切换时从material重新读取，避免使用过期的items数组
6. **图片URL保存**: 从DOM的`backgroundImage`或`video.src`提取当前URL保存到material

### 图片保存逻辑

```javascript
// 保存图片URL（支持图片和视频）
const bgImage = imageWrapper.style.backgroundImage;
const videoEl = imageWrapper.querySelector('video[data-material-video="true"]');

if (videoEl && videoEl.src) {
  // 保存视频URL
  setNestedValue(material, `${pageKey}.${currentItemPath}.images.main`, videoEl.src);
  setNestedValue(material, `${pageKey}.${currentItemPath}.isVideo`, true);
} else if (bgImage && bgImage !== 'none') {
  // 提取并保存图片URL
  const match = bgImage.match(/url\(['"]?([^'"]+)['"]?\)/);
  if (match && match[1]) {
    setNestedValue(material, `${pageKey}.${currentItemPath}.images.main`, match[1]);
    setNestedValue(material, `${pageKey}.${currentItemPath}.isVideo`, false);
  }
}
```

### 测试场景

✅ **场景1**: 编辑title → 切换到item2 → 切换回item1 → title保留  
✅ **场景2**: 上传图片 → 切换section → 回来图片仍在  
✅ **场景3**: 编辑description → Save All → 刷新页面 → 内容保留  
✅ **场景4**: 修改imageLabel → 切换 → Undo → 恢复修改前状态

---

## 2026-02-15: TIL 图片切换后回退旧图（二次修复）

### 现象

已上传图片在 TIL 中可即时显示，但一切换 section 或 item 后回退为旧图。

### 根因

`updateImageContent()` 之前优先读取 `item.imgUrl`。  
而上传流程实际保存的是 `images.main`（`data-material-img` 对应路径）。  
当旧数据里 `imgUrl` 仍存在时，切换后会优先命中旧值，覆盖刚上传的图片。

另外 `collapseDetail()` 曾按初始 `bgStyle` 回填背景，也会把新图覆盖掉。

### 修复

1. `updateImageContent()` 改为**优先读取** `material[indexPath].images.main`
2. `imgUrl` 仅作为向后兼容 fallback
3. `isVideo` 优先读取 `material[indexPath].isVideo`
4. `collapseDetail()` 不再按初始 `bgStyle` 还原，改为从最新 material 读取当前 item 并调用 `updateImageContent()`

### 结果

- 上传图片/视频后，切换 item 与切换 section 均不再回退旧图
- 离线/在线模式保持同一套显示优先级（`images.main` 为准）

---

## 2026-02-15: TIL 图片 zoom/x/y 参数不回显修复

### 问题

编辑界面中调整了图片 `X/Y/Zoom`（已写入 `images.position`），切换 section/item 后视觉上恢复成默认 `cover + center`，看起来像“没保存”。

### 根因

`saveImagePosition()` 已正确保存到：
- `index.<section>.items.<i>.images.position.x`
- `index.<section>.items.<i>.images.position.y`
- `index.<section>.items.<i>.images.position.scale`

但 `updateImageContent()` 在切换渲染时优先把背景样式重置为 `item.bgStyle` 或 `cover/center`，没有优先读取 `images.position`。

### 修复

在 `updateImageContent()` 增加渲染优先级：
1. 优先应用 `images.position`（x/y/scale）
2. 若无 position，再回退到 legacy `bgStyle`
3. 再回退到默认 `cover + center`

### 效果

- 调整 `zoom/x/y` 后切换 section/item 可正确回显
- `Save All` 后刷新页面，位置参数仍生效

---

## 2026-02-15: TIL 双状态图片参数与 detail 切换图同步修复

### 现象

1. 图片在 `details` 前后两种状态调节 `X/Y/Zoom` 都表现为“没保存”  
2. 在 `details` 状态切换 section/item 时，文字会切换但图片不切换

### 根因

- `updateImageContent()` 在切换渲染时会重置背景样式，覆盖已保存参数  
- detail 状态使用自然图（`.til-detail-natural-img`），原先 `X/Y/Zoom` 仅作用于背景图  
- 切换时 detail 的图片未按目标 item 强制更新

### 修复

1. **分状态保存路径（按你确认的 separate）**  
   - collapsed 保存到 `images.positionCollapsed`  
   - detail 保存到 `images.positionDetail`  
   - 兼容回退到旧 `images.position`

2. **渲染优先级修正**  
   - collapsed: `positionCollapsed` > `position` > `bgStyle` > 默认  
   - detail: `positionDetail` > `position` > 默认（应用到自然图 transform）

3. **detail 切换图片强制同步**  
   - detail 状态下切换 item 时，更新 `.til-detail-natural-img.src` 为目标 item 图片  
   - `collapseDetail()` 先切换状态为 collapsed，再按 collapsed profile 回放图片参数

### 涉及文件

- `js/section-renderer.js`
- `docs/js/section-renderer.js`

---

## 2026-02-15: collapsed 切换仍重置（补丁）

### 现象

在 collapsed 状态拖动 X/Y/Zoom 后，立即切换 item/section 仍有概率回到旧参数。

### 原因

滑杆 `input` 阶段只更新了 DOM 样式，真正写 material 在 `change`。  
用户快速切换时可能尚未触发 `change`，导致切换读取到旧值。

### 修复

新增 `cacheImagePosition()`：
- 在 `input` 事件实时把当前值写入对应路径（collapsed/detail 分状态路径）
- 仅更新内存，不打快照、不立即 patch（避免频繁网络/历史记录）
- `change` 仍走 `saveImagePosition()` 做正式保存（含快照与在线 patch）

### 结果

- collapsed/detail 下拖动后即使立刻切换，也能回显最新参数

---

## 2026-02-15: Save All 不持久化图片位置数据 & DOM 直读补丁

### 现象

1. 调整 TIL 图片缩放/位置后点 "Save All"，保存到文件后刷新页面，缩放数据回到初始值。
2. 即使 `cacheImagePosition` 已把数据写入内存 `material`，文件里的 `material.json` 依然没有 `positionCollapsed` 字段。

### 根本原因

两层问题叠加：

1. **Save All 前缺少数据采集**：`saveCurrentTILData()` 只在 `switchToIndex` 切换 item 时调用。若用户直接点 Save All（不切换 item），当前项的位置数据根本不会从 DOM 采集到 `material` 对象中。
2. **`saveCurrentTILData` 此前不保存位置**：该函数保存了 title/description/imageURL，但**完全遗漏了 backgroundSize/backgroundPosition**（即 X/Y/Zoom 的 DOM 表征）。

### 修复

#### A. `saveCurrentTILData()` 增加 DOM 位置采集

在保存图片 URL 之后，新增一段逻辑直接从 DOM 样式读取当前位置：

- **collapsed 状态**：读 `imageWrapper.style.backgroundPosition` 和 `backgroundSize`，解析为 `{ x, y, scale }` 写入 `images.positionCollapsed`。
- **detail 状态**：读 `naturalImg` 的 `data-pos-x/y/scale` 属性写入 `images.positionDetail`。

这种"直接从 DOM 读"的策略绕过了滑杆闭包 `posPath` 可能指向错误 item 的问题（闭包的 posPath 在 item 切换后不会更新，但 DOM 样式始终是当前可见状态）。

#### B. 暴露 `flushPendingEdits()` 钩子

- `SectionRenderer` 新增模块级数组 `_flushCallbacks`。
- 每个 TIL section 初始化时将自己的 `saveCurrentTILData` push 进去。
- `render()` 开头清空 `_flushCallbacks`（防止重渲染后重复注册）。
- 新增公开函数 `flushPendingEdits()`：遍历调用所有回调。

#### C. `saveAll()` 开头触发 flush

```js
async function saveAll() {
  if (window.SectionRenderer && window.SectionRenderer.flushPendingEdits) {
    window.SectionRenderer.flushPendingEdits();
  }
  // ... 继续获取 material 并保存
}
```

这确保 Save All 执行前，当前正在编辑的 TIL item 的所有数据（文字、图片 URL、位置缩放）全部从 DOM 采集到 `material` 对象中。

### 涉及文件

- `js/section-renderer.js` / `docs/js/section-renderer.js`
  - `saveCurrentTILData()`: 新增 backgroundPosition/backgroundSize → positionCollapsed 采集
  - `_flushCallbacks` 注册/清理机制
  - 导出 `flushPendingEdits()`
- `js/editor.js` / `docs/js/editor.js`
  - `saveAll()`: 开头调用 `flushPendingEdits()`

### 结果

- 调整图片位置/缩放后直接 Save All → `material.json` 中包含 `positionCollapsed`/`positionDetail`
- 刷新页面后位置数据正确恢复
- 切换 item 后再 Save All 同样有效（`saveCurrentTILData` 在切换时+Save All前各触发一次）

---

## 2026-02-15: Text Image Right 完整镜像修复（与 Text Image Left 功能一致）

### 问题

用户反馈 `text-image-right` 在编辑器中仍显示旧样式，且 section 交互功能不完整（切换/详情/集合编辑行为异常）。

### 根因

1. `text-image-right` 模板结构未完全遵循 TIL 运行时所依赖的 DOM 契约。  
   `section-renderer.js` 的 TIL 初始化强依赖：
   - `data-til-left-area`（文本区）
   - `data-til-right-wrapper` + `data-til-right-area`（图片区）
   - `data-til-content-wrapper` / `data-til-collapsed-content` / `data-til-detail-content`
2. 编辑器集合配置只覆盖了 `text-image-left`，未覆盖 `text-image-right`，导致右侧模板在编辑模式下新增/删除 item 的行为不完整。

### 修复内容

#### 1) 模板层（`js/templates.js` 与 `docs/js/templates.js`）

- `textImageRightTemplate()` 改为与 `textImageLeftTemplate()` 同构，仅做**左右镜像**：
  - 文本区仍使用 `data-til-left-area`，但定位到右侧（`absolute right-0`）
  - 图像区仍使用 `data-til-right-wrapper` / `data-til-right-area`，但定位到左侧（`absolute left-0`）
- 增加 `data-til-layout="mirrored"` 标记，供运行时处理镜像锚点。
- 保留与 left 模板一致的主题、切换、detail 展开、material 绑定与数据路径逻辑。

#### 2) 运行时层（`js/section-renderer.js` 与 `docs/js/section-renderer.js`）

- 在 TIL 初始化中读取 `data-til-layout`，新增镜像分支：
  - detail 展开时，`rightWrapper` 依据布局方向锚定：
    - 默认：`right: 0`
    - 镜像：`left: 0`
  - detail 收起时同样按布局方向恢复锚点。
- 这样保证镜像布局下，detail 动画和宽度联动行为与 left 模板一致，不会“跳边”。

#### 3) 编辑器层（`js/editor.js` 与 `docs/js/editor.js`）

- 在 `collectionEditorConfig` 新增 `text-image-right` 配置（`path: items`, `addLabel: Add Section`）。
- `createDefaultCollectionItem()` 中把 `text-image-right` 纳入与 `text-image-left` 相同的默认项生成逻辑。

### 结果

- `text-image-right` 现在与 `text-image-left` 功能一致：
  - 同样的 section 切换
  - 同样的 detail 展开/收起与联动动画
  - 同样的编辑模式新增/删除 item 能力
  - 同样的主题与样式体系
- 唯一差异：**图片与文本左右位置互换**。

### 主题修正（补充）

根据确认，`text-image-right` 需要与 TIL 保持同样的深色观感，因此将该模板主题逻辑改为**始终深色**：

- `js/templates.js`：`const theme = 'dark'`
- `docs/js/templates.js`：同步同样修改

结果：`text-image-right` 在所有 section 下统一使用深色背景与深色按钮/文本体系，不再按 section id 切换浅色。

### 纠偏记录（主题赋值误改）

排查中发现一次误操作：之前将固定深色误写到 `text-image-left`，而 `text-image-right` 仍保留旧的按 section 判断逻辑，导致 TIR 仍可能呈现浅色。

已纠正为：
- `text-image-left`：恢复原逻辑（`safety/innovation` 深色，其余按原规则）
- `text-image-right`：固定 `const theme = 'dark'`

同步文件：
- `js/templates.js`
- `docs/js/templates.js`

### TIR 顶部总标题/描述补充（与 TIL 结构一致 + 旧数据兼容）

问题：`text-image-right` 已有与 TIL 同构的上方 `headline/subheadline` 区块，但当前 `sustainability` 仍是旧数据结构（仅 `title/description`），导致顶部区块在运行时不显示。

修复（不改 material 数据）：
- 在 `textImageRightTemplate()` 增加运行时回退：
  - `headline = data.headline || data.title || ''`
  - `subheadline = data.subheadline || data.description || ''`

这样可在不迁移 `material.json` 的前提下立即显示顶部总标题/描述；后续如补齐 `headline/subheadline` 字段，将优先使用新字段。

同步文件：
- `js/templates.js`
- `docs/js/templates.js`

### 一致性复核补充：TIL/TIR 顶部标题取值策略统一

根据“对齐 TIL 最新逻辑”要求，复核后发现 TIL/TIR 在顶部标题取值存在不一致风险。

已统一为同一策略（两者一致）：
- `headline = data.headline || data.title || ''`
- `subheadline = data.subheadline || data.description || ''`

这样保证：
- 新结构（headline/subheadline）优先；
- 旧结构（title/description）仍可显示顶部总标题区；
- TIL/TIR 在同一数据形态下表现一致（TIR 仅保留左右镜像与深色主题差异）。

### 图片加载修复补充（首项正常、后续项不显示）

现象：某些 TIL/TIR section 只有第一个 item 图片可见，切换到后续 item 后图片不显示。  

根因：`section-renderer.js` 中用于切换与 detail 的本地 `getImageUrl(path, material)` 仅做对象层级读取，未完整处理：
- `pageKey` 前缀（`index.`）解析；
- 与模板层一致的媒体 URL 规范化（`imagesBasePath`、`uploads/`、http/data/blob 等）。

导致切换时可能读到空值或裸文件名，最终背景图 URL 无效。

修复：
- 在 `initializeTextImageLeftSwitchers()` 内两处 `getImageUrl()` 统一为：
  - 优先按 `pageKey + path` 读取（并保留直接 path 回退）
  - 对字符串路径执行与模板层一致的 URL 规范化
  - 自动拼接 `material.config.imagesBasePath`（回退 `assets/images/`）

同步文件：
- `js/section-renderer.js`
- `docs/js/section-renderer.js`

### 内容回滚：恢复 `sustainability` 的 Fossil fuels 版本（来自 Git 历史）

问题：用户反馈该部分被覆盖为默认占位文案，原本应为包含 `Fossil fuels` 的多 item 内容。

处理方式：
- 从 Git 历史提交 `3fe4db0` 的 `docs/material.json` 提取 `index.sustainability`
- 将该结构回填到根目录 `material.json` 的 `index.sustainability`

恢复后特征：
- `sustainability.items` 多 section 内容恢复
- 包含 `Fossil fuels` 相关标题与描述文本
- 不再是默认的 `Green. Clean. Future.` 单段占位结构

### 一致性补丁：TIL/TIR 切换时按钮主题回退修复

在 `section-renderer.js` 的 `switchToIndex()` 中，原逻辑通过 section id（`safety/innovation`）硬编码推断主题，导致：
- `text-image-right`（已改为深色）在切换 item 时，按钮激活态可能按浅色规则回写 class。

修复方式：
- 改为读取容器真实主题：`data-til-theme`（无则回退初始化时的 `theme`）
- `updateButtonStates()` 使用该动态主题值

同步文件：
- `js/section-renderer.js`
- `docs/js/section-renderer.js`

结果：
- TIL/TIR 在 item 切换、展开/收起后的按钮主题行为一致，避免切换后视觉“跳回浅色”。

---

## 2026-02-15: Sustainability(TIR) 四个 Section 内容填充与引用适配

### 需求

将 `PinS-Fossil-Fuel-Sections1-4.md` 的 1-4 Section 按 `Title / Key Sentences / Details` 填入 `docs` 中 `sustainability`（TIR）对应内容，保持原文不变，仅允许为排版、公式渲染、Reference 引用做适配。

### 实现

1. 更新 `docs/material.json` 的 `index.sustainability.items`：
   - 由 2 个占位 item 扩展为 4 个 section：
     - Energy Conversion Efficiency
     - Environmental impact
     - Safety
     - Economic cost
   - 映射规则：
     - `title` <- Title
     - `description` <- Key Sentences
     - `detail` <- Details

2. 数学公式渲染适配：
   - 将 Section 1 中原文的 fenced `latex` 公式改为站点可渲染的 `$$ ... $$` 块公式。
   - 保留行内公式（如 `$T_H$`、`$T_C$`）格式。

3. Reference 引用适配：
   - 将 `References:`/`Reference:` 的 URL 列表转换为正文中的 `<sup class="ref-cite" data-ref-id="...">[...]</sup>` 引用。
   - 在 `index.footer.reference.items` 末尾新增 `id: 22-31` 的参考文献条目，与新增引用一一对应。

### 结果

- `sustainability` 区块现在可直接展示 4 个完整 section 的 TIR 内容。
- 公式在前端详情区可按现有 LaTeX 渲染流程显示。
- 引用采用站内统一编号体系，可与现有 Reference 交互一致。

---

## 2026-02-15: Safety（TIL）details 排版优化（仅换行）

### 需求

基于 `MSR Write Up.docx`，对 `docs` 中 `ID: Safety` 对应 TIL 的 `detail` 做排版优化，重点是换行与段落可读性；不改动原有内容语义与引用标签。

### 实现

- 修改文件：`docs/material.json`
- 修改位置：`index.sustainability.items` 中 `tab = "Safety"` 的 `detail`
- 修改方式：仅调整换行（增加段落分隔与句间断行），未新增或删改正文词句、标点及 `<sup class="ref-cite"...>` 引用。

### 结果

- Safety 详情在展开态阅读时层次更清晰，长段落可读性提升。
- 内容本体保持一致，仅做版式层面的换行优化。

### 纠偏（同日）

- 用户反馈 section 对不上后，复核发现此前定位到了 `index.sustainability.items[].tab="Safety"`，并非目标的 `index.safety.items`（MSR TIL）。
- 已修正 `docs/material.json` 中 `index.safety.items[0]`（`tab/title = "What are MSRs?"`）的 `detail`，改回与文档对应的 What are MSRs 正文，并按段落换行优化可读性。
- 为避免本地回退数据不一致，同时同步了 `docs/index.html` 中 `window.__PRELOADED_MATERIAL__` 的同一字段。

---

## 2026-02-15: Detail 文字内容（含换行）切换/刷新后不保存

### 现象

用户在 TIL 的 detail 展开态编辑文字内容（尤其包含换行），切换 section 或刷新后编辑内容丢失。

### 根本原因（三层叠加）

1. **`saveCurrentTILData()` 完全遗漏 detail 文本**：只保存了 title、description、imageLabel、图片 URL 和位置，但从未读取 `detailTextEl.innerHTML` 并写入 `material`。
2. **`switchToIndex` 未更新 `detailTextEl` 和 `detailTitleEl` 的 `data-material` 属性**：item 切换时，collapsed 的 title/desc/imageLabel 的 `data-material` 路径都更新了，但 detail 面板的两个元素没有。导致 `handleTextEdit`（blur 事件保存）使用旧 path 写入了错误 item 的数据。
3. **`handleTextEdit` 对 detail 元素用 `textContent` 而非 `innerHTML`**：detail 文本包含换行（`<br>`/`<div>`）、引用标记等 HTML 结构。`textContent` 会剥离所有 HTML 标签，仅保留纯文本，导致换行和格式全部丢失。

### 修复

#### A. `saveCurrentTILData()` 新增 detail 采集

```js
if (detailTitleEl) {
  const currentDetailTitle = detailTitleEl.textContent.trim();
  if (currentDetailTitle) {
    setNestedValue(material, `${pageKey}.${currentItemPath}.title`, currentDetailTitle);
  }
}
if (detailTextEl) {
  const currentDetail = detailTextEl.innerHTML.trim();
  if (currentDetail && currentDetail !== 'Detail content goes here.') {
    setNestedValue(material, `${pageKey}.${currentItemPath}.detail`, currentDetail);
  }
}
```

使用 `innerHTML` 而非 `textContent`，保留换行和富文本结构。

#### B. `switchToIndex` 更新 detail 路径

```js
if (detailTitleEl) detailTitleEl.setAttribute('data-material', `${itemPath}.title`);
if (detailTextEl) detailTextEl.setAttribute('data-material', `${itemPath}.detail`);
```

确保 blur → `handleTextEdit` 写入正确 item 路径。

#### C. `handleTextEdit` 对 detail 元素使用 innerHTML

```js
const isDetailContent = el.hasAttribute('data-til-detail-text') || (path && path.endsWith('.detail'));
const useHtml = canContainRefs || isDetailContent;
const newValue = useHtml ? el.innerHTML.trim() : el.textContent.trim();
```

对 detail 元素始终用 innerHTML 保存，无论是否包含 `.ref-cite`。

### 涉及文件

- `js/section-renderer.js` / `docs/js/section-renderer.js`
  - `saveCurrentTILData()`: 新增 detailTitleEl/detailTextEl 采集
  - `switchToIndex()`: 新增 detailTitleEl/detailTextEl 的 data-material 路径更新
- `js/editor.js` / `docs/js/editor.js`
  - `handleTextEdit()`: 新增 `isDetailContent` 判断，detail 元素用 innerHTML

### 结果

- Detail 编辑含换行的内容 → 切换 section 后回切 → 内容保留
- Save All 后刷新 → 内容保留
- 引用标记、LaTeX 公式等富文本结构在保存/恢复循环中保持完整
