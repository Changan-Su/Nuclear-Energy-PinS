# v0.8 斜杠命令与媒体插入功能

**实现日期**: 2025-02-15

## 功能概述

为所有 detail 编辑区域添加了 '/' 命令触发机制,支持快速插入图片和视频,并可以通过拖拽调整大小。

## 核心功能

### 1. '/' 命令触发系统 (类似 @ mention)

在所有包含 `data-material` 且 `contenteditable="true"` 的 detail 编辑区域:
- 输入 `/` 字符自动弹出命令菜单
- 支持键盘导航 (↑↓ 箭头键、Enter 确认、Esc 取消)
- 命令菜单包含:
  - **插入图片**: 上传本地图片文件
  - **插入视频**: 上传本地视频文件

**实现位置**: `js/editor.js` (2722行起)
- `setupSlashCommandSystem()`: 初始化斜杠命令系统
- `handleSlashKeyup()`: 处理斜杠键入事件
- `showCommandDropdown()`: 显示命令下拉菜单
- `executeCommand()`: 执行选中的命令

### 2. 媒体上传功能

**上传流程**:
1. 用户选择 "插入图片" 或 "插入视频" 命令
2. 触发浏览器原生文件选择器
3. 文件上传到服务器 `/upload` 端点
4. 返回文件URL
5. 将媒体块插入到 detail 内容末尾

**实现函数**:
- `triggerMediaUpload()`: 触发文件上传
- `uploadMediaFile()`: 执行文件上传请求
- `insertMediaBlock()`: 将上传的媒体插入到 material 数据中

### 3. detailBlocks 数据结构

引入新的富文本块数组结构,取代原有的简单字符串 `detail` 字段:

```javascript
// 旧格式
{
  detail: "这是一段文本内容..."
}

// 新格式
{
  detailBlocks: [
    { type: 'text', content: '这是一段文本内容...' },
    { type: 'image', url: '/uploads/image.jpg', width: 600 },
    { type: 'video', url: '/uploads/video.mp4', width: 800 }
  ]
}
```

**向后兼容**:
- 如果 `detailBlocks` 不存在,渲染时会自动使用旧的 `detail` 字符串
- 首次插入媒体时,会自动将 `detail` 字符串迁移为 `detailBlocks` 数组

### 4. 媒体块渲染

**实现位置**: `js/templates.js`

新增 `renderDetailBlocks()` 函数,支持三种块类型:
- **text块**: 普通文本段落
- **image块**: 图片,居中显示,可调整宽度
- **video块**: 视频,居中显示,可调整宽度,包含播放控件

每个媒体块包含:
- 居中布局容器 (`.detail-media-block`)
- 可调宽度包裹器 (`.detail-media-wrapper`)
- 媒体内容 (图片/视频)
- 拖拽调整把手 (`.detail-media-resize-handle`)
- 删除按钮 (`.detail-media-delete`)

**修改的渲染函数**:
- `renderDetailContent()`: 支持 `detailBlocks` 和 `detailBlocksPath` 参数
- `renderFlipWrapper()`: 传递 `detailBlocks` 到 detail 内容渲染

**更新的模板**:
- `tabbedContentTemplate()` (Highlights)
- `textImageLeftTemplate()` (Safety, Innovation)
- `textImageRightTemplate()` (Economy)
- `accordionTemplate()` (Closer Look)

### 5. 拖拽调整大小功能

**实现位置**: `js/editor.js` (3000行起)

**交互流程**:
1. 鼠标悬停在媒体块上,显示右侧调整把手
2. 拖拽把手左右移动
3. 实时更新媒体块宽度 (限制在 200px - 1200px)
4. 松开鼠标,自动保存新宽度到 material.json

**实现函数**:
- `initMediaResizeHandlers()`: 初始化调整大小监听器
- `handleResizeStart()`: 开始拖拽
- `handleResizeMove()`: 拖拽过程中更新宽度
- `handleResizeEnd()`: 完成拖拽,保存宽度
- `updateMediaBlockWidth()`: 更新 material 中的宽度数据

### 6. 媒体块删除功能

在编辑模式下,媒体块右上角显示删除按钮:
- 点击删除按钮移除对应的 media block
- 自动更新 `detailBlocks` 数组
- 重新渲染 detail 内容

**实现函数**: `handleMediaDelete()`

### 7. CSS 样式

**新增样式** (`css/styles.css`, 2180行起):

```css
/* 命令下拉菜单 */
.command-dropdown
.command-dropdown-item
.command-dropdown-item-icon
.command-dropdown-item-content

/* 媒体块 */
.detail-media-block
.detail-media-wrapper
.detail-media-content
.detail-media-resize-handle
.detail-media-delete

/* 上传指示器 */
.upload-indicator
.upload-spinner
```

## 使用场景

### 适用的 detail 区域

所有包含以下特征的编辑区域都支持 '/' 命令:
- 具有 `data-material` 属性
- 属性值包含 "detail" 路径
- `contenteditable="true"` (编辑模式)

包括但不限于:
- Highlights (tabbed-content) 的每个 tab 的 detail
- Features (card-grid) 的每个卡片的 detail
- Safety, Innovation, Economy (text-image) 的 detail
- Closer Look (accordion) 的每个 feature 的 detail
- Interactive Details 的每个 item 的 detail

### 用户操作流程

1. 进入编辑模式
2. 点击任意 detail 内容区域
3. 输入 `/` 触发命令菜单
4. 选择 "插入图片" 或 "插入视频"
5. 在文件选择器中选择文件
6. 等待上传完成
7. 图片/视频自动插入到 detail 末尾
8. 鼠标悬停在媒体块上,拖拽右侧把手调整宽度
9. 保存修改

## 技术细节

### 数据流

```
用户输入 '/'
  ↓
显示命令菜单
  ↓
选择命令 (image/video)
  ↓
触发文件上传
  ↓
上传到 /upload 端点
  ↓
获取文件 URL
  ↓
更新 material.detailBlocks
  ↓
重新渲染 detail 内容
  ↓
初始化调整大小监听器
```

### 与现有功能的集成

1. **@ 引用系统**: 斜杠命令系统与 @ 引用系统并行工作,互不干扰
2. **编辑模式**: 斜杠命令只在编辑模式 (`edit-mode` class) 下激活
3. **材料保存**: 媒体块数据自动保存到 material.json
4. **离线导出**: 支持导出到本地文件夹

### 初始化时机

在 `enable()` 函数中:
```javascript
setupAtMentionSystem();      // @ 引用系统
setupSlashCommandSystem();   // 斜杠命令系统
setupCitationClickHandlers(); // 引用点击处理
initMediaResizeHandlers();   // 媒体调整大小
```

在 `disable()` 函数中:
```javascript
cleanupAtMentionSystem();
cleanupSlashCommandSystem();
removeCitationClickHandlers();
```

## 已知限制

1. **插入位置**: 目前只能在 detail 文本末尾插入媒体,不能在文本中间插入
2. **编辑文本块**: 插入媒体后,原有 detail 文本会变成 text 块,但暂不支持直接编辑 text 块内容
3. **文件大小**: 未限制上传文件大小,需要服务器端配置
4. **拖拽方向**: 只支持左右拖拽调整宽度,不支持调整高度

## 未来改进方向

1. 支持在光标位置插入媒体 (需要更复杂的富文本编辑器)
2. 支持编辑 text 块内容
3. 支持更多媒体类型 (音频、PDF 等)
4. 支持从 URL 插入媒体
5. 添加图片裁剪和编辑功能
6. 支持拖拽排序媒体块

## 测试建议

1. ✅ 在不同 detail 区域测试 '/' 命令触发
2. ✅ 测试上传不同格式的图片 (jpg, png, gif)
3. ✅ 测试上传不同格式的视频 (mp4, webm)
4. ✅ 测试拖拽调整媒体大小
5. ✅ 测试删除媒体块
6. ✅ 测试保存和重新加载
7. ✅ 测试向后兼容 (旧的 detail 字符串格式)
8. ✅ 测试离线导出功能

## 相关文件

- `js/editor.js`: 斜杠命令系统、媒体上传、调整大小
- `js/templates.js`: detailBlocks 渲染、模板更新
- `css/styles.css`: 命令菜单、媒体块样式
- `server/routes/upload.js`: 文件上传端点 (已有)

## 内容更新：docs/MSR 页面填充（来自 MSR Write Up.docx）

**实现日期**: 2026-02-15

将 `docs` 站点的 MSR（`interactive-details` 模板）从占位内容替换为文档原文，并按 **Section / Key Sentences / Details** 三段式组织内容，尽可能保留原句与段落结构。

- **数据更新位置**: `docs/material.json` 的 `index.MSR`
- **离线回退一致性**: 同步更新 `docs/index.html` 内嵌的 `window.__PRELOADED_MATERIAL__` 对应 `MSR` 块（避免 `file://` 下 fetch 失败时内容不一致）

MSR Items 拆分为：
- Summary for Main Page
- What are MSRs?
- How MSRs work
- Fuel recycling / cleaning
- Alternative fuel sources
- Increased passive safety
- Reduced / less dangerous waste and byproducts
- Challenges surrounding MSRs
- References

### 修正：按文档 1/2/3 Section 收敛为 3 项

根据 `MSR Write Up.docx` 中明确标注的 1/2/3 Section，将 MSR 的 `interactive-details` 左侧目录收敛为 **3 个 items**：
- **1. What are MSRs?**（合并 Summary + 定义 + 分类）
- **2. How MSRs Work**（Similarities/Differences）
- **3. Benefits and challenges**（合并 benefits 各子段 + challenges + references）

实现方式：更新 `docs/material.json` 与 `docs/index.html` 内嵌回退数据中的 `index.MSR.items`，由多条 Topic 合并为 3 条 Section，内容尽量保持原文句子与段落顺序。
