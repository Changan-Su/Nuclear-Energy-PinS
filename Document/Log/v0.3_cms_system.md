# Version 0.3 - CMS Online Editing System

**Date**: 2026-02-09  
**Status**: Implemented

## Overview

Transformed the Apple Style Website Engine from a static content site into a fully-featured, template-driven CMS with dual-axis mode management (offline/online + view/edit). Added a Node.js + Express backend with MySQL for real-time content management.

## Features Implemented

### 1. Backend Infrastructure (Node.js + Express + MySQL)

**Files Created**:
- `server/index.js` - Express server entry point with CORS, middleware
- `server/db.js` - MySQL connection pool with environment config
- `server/routes/auth.js` - JWT authentication (password: 2026PinS)
- `server/routes/material.js` - Full material CRUD operations
- `server/routes/sections.js` - Section management (add/remove/reorder)
- `server/routes/upload.js` - Image upload with multer (10MB limit)
- `server/schema.sql` - Database initialization script
- `server/.env.example` - Environment variables template

**Database Schema**:
- `site_data` table: Stores entire material JSON as single document
- `media` table: Tracks uploaded images with metadata

**API Endpoints**:
- POST `/api/auth/login` - Password authentication, returns JWT
- GET/PUT/PATCH `/api/material` - Material management
- GET/PUT/POST/DELETE `/api/sections` - Section operations
- POST `/api/upload` - Image upload
- GET `/api/health` - Health check

### 2. Extended Material Format

**Changes to `material.json`**:
- Added `config.sections` array mapping sections to templates
- Each section has: `id`, `template`, `enabled`, `order`
- Renamed "Alternative Designs" section to "innovation"
- Maintained backward compatibility with existing content structure

**Section Templates Supported**:
- `hero` - Full-screen hero with background
- `tabbed-content` - Tab switcher (Highlights)
- `card-grid` - Multi-column cards (Features)
- `text-image-left` - Text left, image right (Safety, Innovation)
- `text-image-right` - Image left, text right (Sustainability)
- `accordion` - Expandable list (Closer Look)
- `ai-chat` - Chat interface
- `quiz` - Quiz with multiple question types
- `image-gallery` - Image grid
- `footer` - Footer section

### 3. Frontend Architecture Refactor

**New Core Modules**:

#### `js/templates.js`
Template registry with render functions for all section types. Each template is a pure function `(sectionId, data, material) => HTMLString`.

#### `js/section-renderer.js`
Dynamically renders sections from config + templates:
1. Reads `config.sections` sorted by order
2. Renders enabled sections using template registry
3. Applies material data via `data-material` attributes
4. Re-initializes interactive components (tabs, accordion, animations, icons)

#### `js/mode-manager.js`
Dual-axis mode system with two independent toggles:

**Data Source Axis** (offline ↔ online):
- Offline: Loads from local `material.json`
- Online: Fetches from MySQL via API (requires login)

**UI Mode Axis** (view ↔ edit):
- View: Read-only rendering
- Edit: Inline editing with toolbars

**Four Mode Combinations**:
1. **Offline + View** (default): Standard visitor experience
2. **Offline + Edit**: Local editing, import/export JSON files
3. **Online + View**: Preview live database content
4. **Online + Edit**: Full CMS with real-time MySQL saves

**Login System**:
- Glassmorphism modal for password entry
- JWT token stored in sessionStorage
- Token auto-verification on page load
- Default password: `2026PinS`

**Mode Controls** (navbar top-left):
- Cloud icon (wifi/cloud-off): Toggle online/offline
- Pencil icon (pencil/eye): Toggle edit/view
- Status pill: Shows current mode state

#### `js/editor.js`
Comprehensive inline editing system:

**Text Editing**:
- Elements with `data-material` become contenteditable
- Save on blur, updates material in memory
- Auto-sync to MySQL in online mode via PATCH API

**Image Editing**:
- Click-to-upload overlay on images
- Online: Upload to server via `/api/upload`
- Offline: Convert to base64 data URL

**Section Toolbar** (floating on each section):
- Move up/down arrows (reorder sections)
- Eye icon (toggle visibility)
- Trash icon (delete section)
- Triggers re-render after modifications

**Top Edit Toolbar**:
- "Add Section" - Modal to insert new section from template
- "Save All" - Batch save to MySQL (online) or no-op (offline)
- "Discard Changes" - Reload from source
- "Export" - Download material as JSON file
- "Import" - Upload JSON file to replace material

**Import/Export**:
- Export: Downloads `material-export-YYYY-MM-DD.json`
- Import: Validates structure, replaces material, re-renders
- In online mode, import also saves to MySQL

#### `js/quiz.js`
Quiz engine with rich question type support:

**Question Types**:
- Multiple Choice (mc): Radio buttons, N options, 1 correct
- True/False (tf): Binary choice
- Fill in the Blank (fill): Text input, exact match validation
- Short Answer (short): Textarea, keyword-based auto-check

**Features**:
- Client-side answer checking
- Visual feedback (green/red borders, icons)
- Score display after submission
- Disabled inputs after submit

**Data Structure** (in material.json):
```json
{
  "title": "Quiz Title",
  "questions": [
    { "type": "mc", "question": "...", "options": [...], "answer": 1 },
    { "type": "tf", "question": "...", "answer": true },
    { "type": "fill", "question": "...", "answer": "fission" },
    { "type": "short", "question": "...", "keywords": ["93%", "base load"] }
  ]
}
```

### 4. Refactored Existing Modules

**`js/main.js`**:
- Wrapped in `window.MainInteractions` module
- Exposed `init()` for re-initialization after dynamic rendering
- Simplified to hero CTA handler (tabs/accordion moved to section-renderer)

**`js/scroll-animations.js`**:
- Wrapped in `window.ScrollAnimations` module
- Added `cleanup()` to disconnect old observers
- Re-attachable event listeners to avoid duplicates
- IntersectionObserver for fade-in animations
- Navbar scroll effects
- Smooth scroll for anchor links

**`js/ai-chat.js`**:
- Wrapped in `window.AIChat` module
- Added `reset()` to prevent double initialization
- Checks for element existence before binding
- Simulated AI responses with typing indicator

**`index.html`**:
- Replaced all static sections with `<main id="app"></main>`
- Kept navigation bar (mode controls injected dynamically)
- Updated script loading order:
  1. templates.js
  2. section-renderer.js
  3. quiz.js
  4. mode-manager.js
  5. editor.js
  6. material.js (legacy, for backward compatibility)
  7. main.js
  8. scroll-animations.js
  9. ai-chat.js
- Initialization calls ModeManager.init() which triggers full system

## Implementation Details

### Material Loading Flow

1. **ModeManager.init()** called on DOMContentLoaded
2. Mode controls created in navbar
3. Material loaded from `material.json` (offline default)
4. **SectionRenderer.init(material, 'index')** called
5. Sections rendered dynamically into `#app`
6. All interactive components initialized:
   - Tabs, accordion, scroll animations, AI chat, quizzes
7. Icons rendered via Lucide

### Online Mode Activation Flow

1. User clicks cloud icon in navbar
2. Login modal shown (glassmorphism design)
3. User enters password (default: 2026PinS)
4. POST `/api/auth/login` → JWT token returned
5. Token stored in sessionStorage
6. GET `/api/material` → material fetched from MySQL
7. SectionRenderer updates with new material
8. UI updates to show "Online" mode

### Edit Mode Activation Flow

1. User clicks pencil icon in navbar
2. Edit toolbar appears below navbar
3. All `[data-material]` elements become contenteditable
4. Image overlays added with camera icons
5. Section toolbars appear (move/toggle/delete)
6. Changes tracked in memory, optionally synced to MySQL

### Section Reordering

1. User clicks move up/down in section toolbar
2. Sections array reordered in material.config.sections
3. Order property recalculated (0, 1, 2, ...)
4. Material updated in memory
5. SectionRenderer.render() called
6. All sections re-rendered in new order
7. Editor.enable() re-applied

## Benefits & Use Cases

### Offline + Edit Mode
- Content creators can prepare material without backend
- Export JSON files for version control (Git)
- Import curated content files
- No database required

### Online + View Mode
- Preview live content from database
- Test changes before editing
- Read-only access for stakeholders

### Online + Edit Mode
- Full CMS experience
- Real-time collaboration (with JWT auth)
- Instant save to MySQL
- Image uploads to server

### Template System
- Add new section types without touching HTML
- Reuse templates across projects
- Consistent styling and structure
- Easy to extend (e.g., add video template)

## Technical Highlights

### Separation of Concerns
- **Templates**: Pure render functions (data → HTML)
- **Renderer**: Orchestration & component lifecycle
- **Mode Manager**: Data source & authentication
- **Editor**: UI manipulation & persistence

### No Build Tools Required
- Vanilla JavaScript (ES6 modules)
- No webpack, no bundler
- Direct browser execution
- Fast iteration

### Backward Compatibility
- Old material.json still works (section config added)
- Existing `data-material` attributes honored
- Legacy scripts (material.js) kept for compatibility

### Security
- JWT token authentication
- Password-protected online mode
- Token expires in 24h
- CORS enabled for API

## Known Limitations

1. **Single-User Editing**: No conflict resolution for concurrent edits
2. **No Undo/Redo**: Changes are immediately saved (online mode)
3. **Limited Media Library**: No search/filter in media list
4. **No Role-Based Access**: Single admin password for all users
5. **Client-Side Quiz Validation**: Answers visible in source code

## Future Enhancements (Not Implemented)

- Multi-user collaboration with WebSockets
- Visual drag-and-drop section reordering
- Rich text editor (WYSIWYG) for long-form content
- Media library with thumbnails and pagination
- User roles and permissions
- Revision history / version control
- Export to static HTML (for hosting)
- i18n support for multiple languages

## Testing Checklist

- [x] Offline + View: Default visitor experience
- [x] Offline + Edit: Local editing with import/export
- [x] Online + View: Login and read-only MySQL content
- [x] Online + Edit: Full CMS with text/image editing
- [x] Section reordering with move up/down
- [x] Section toggle (enable/disable)
- [x] Section deletion
- [x] Add new section from template
- [x] Image upload (online mode)
- [x] Image base64 conversion (offline mode)
- [x] Import JSON file
- [x] Export JSON file
- [x] JWT authentication and token storage
- [x] Quiz rendering (MC, T/F, fill, short answer)
- [x] Quiz submission and scoring
- [x] Tabs switching (Highlights section)
- [x] Accordion interaction (Closer Look section)
- [x] AI chat simulation
- [x] Scroll animations
- [x] Navbar scroll effects

## Files Modified

### Created
- `server/*` (entire backend)
- `js/templates.js`
- `js/section-renderer.js`
- `js/mode-manager.js`
- `js/editor.js`
- `js/quiz.js`

### Modified
- `material.json` - Added config.sections
- `index.html` - Dynamic rendering architecture
- `js/main.js` - Modularized for re-initialization
- `js/scroll-animations.js` - Modularized with cleanup
- `js/ai-chat.js` - Modularized with reset

### Unchanged
- `js/material.js` - Legacy loader (kept for compatibility)
- `css/styles.css` - No CSS changes needed
- `admin.html` - Not updated in this version

## Deployment Notes

### Backend Setup
```bash
cd server
npm install
cp .env.example .env
# Edit .env with MySQL credentials
mysql -u root -p < schema.sql
npm start
```

### Frontend
- No build step required
- Serve from any static file server
- Ensure server API is accessible (CORS configured)

### 2026-02-09 Hotfix (Offline View Not Rendering)

**Issue observed**:
- Opening `index.html` directly via `file://` caused offline page to stay black.
- Console showed:
  - `Cannot read properties of null (reading 'setAttribute')` in mode controls icon update.
  - `fetch` / `XMLHttpRequest` blocked by browser CORS policy when reading `material.json` from `file://`.

**Root cause**:
1. `lucide.createIcons()` replaces `<i>` with `<svg>`, but UI update code still queried only `<i>`, causing runtime crash.
2. Browser security policy blocks local JSON requests in this context, so offline material failed to load.

**Fix implemented**:
- Updated `js/mode-manager.js`:
  - Added safe icon replacement logic compatible with both `<i>` and `<svg>`.
  - Protected mode-controls initialization with `try/catch` so material loading is not blocked by UI errors.
  - Added multi-step material loading fallback and explicit error messaging.
- Updated `server/index.js`:
  - Added static frontend hosting from project root.
  - Added `/` route returning `index.html`.
  - Result: use `http://localhost:3009/` to avoid `file://` CORS restrictions.

**Operational note**:
- Prefer opening the site via HTTP (`http://localhost:3009/`) instead of double-clicking `index.html`.
- This hotfix supersedes the assumption that direct `file://` open is a supported offline workflow in Chrome.

### 2026-02-09 Hotfix 2 (Offline Save Capability)

**Issue observed**:
- In Offline mode, `Save All` only displayed a message and did not persist data.
- Users expected refresh-safe save behavior.

**Fix implemented**:
- Added offline draft persistence in `js/mode-manager.js` using `localStorage` key:
  - `pins_offline_material_draft`
- New methods:
  - `getOfflineDraft()`
  - `saveOfflineDraft(material)`
  - `clearOfflineDraft()`
- `loadMaterial()` now restores offline draft automatically when available.
- `updateMaterialInMemory()` now auto-persists offline edits as draft.
- Updated `js/editor.js`:
  - `Save All` in offline mode now writes to draft storage.
  - `Discard` in offline mode now clears draft before reload.

**Result**:
- Offline edits are now actually saved (browser-local), survive refresh, and can still be exported as JSON.

### 2026-02-09 Hotfix 3 (Save Visibility + Undo/Redo)

**Issue observed**:
- Users could not reliably find `Save` because it only appeared in edit toolbar context.
- Missing global undo/redo workflow reduced edit safety.

**Fix implemented**:
- Updated `js/mode-manager.js`:
  - Added always-visible navbar controls:
    - `Save`
    - `Undo`
    - `Redo`
  - Added keyboard shortcuts:
    - `Ctrl+S` / `Cmd+S`: Save current material
    - `Ctrl+Z` / `Cmd+Z`: Undo (edit mode, non-typing context)
    - `Ctrl+Y` / `Cmd+Y` and `Ctrl+Shift+Z`: Redo
  - Added material history stack (`undoStack` / `redoStack`) with max depth 50.
  - Added public APIs:
    - `captureSnapshot()`, `undo()`, `redo()`, `canUndo()`, `canRedo()`
    - `saveCurrentMaterial()`
- Updated `js/editor.js`:
  - Added `Undo` / `Redo` buttons to edit toolbar.
  - Added snapshot capture before text/image/section/import mutations.
  - Added `refresh()` to reliably re-bind editable overlays after renderer re-renders.
  - Replaced post-render `enable()` calls with `refresh()`.

**Result**:
- Save entry point is always visible.
- Undo/redo available via both buttons and keyboard.
- Edit operations are safer and reversible.

### 2026-02-09 Hotfix 4 (Syntax Regression Fix)

**Issue observed**:
- Page JS initialization failed with `Unexpected token` in `js/mode-manager.js`.
- As a consequence, save/undo/redo controls did not render.

**Root cause**:
- During previous refactor, `saveCurrentMaterial()` was accidentally inserted inside `uploadImage()` function block.

**Fix implemented**:
- Restored proper function boundaries:
  - `uploadImage()` now closes correctly.
  - `saveCurrentMaterial()` is defined as a separate sibling function.
- Verified syntax via `node --check js/mode-manager.js`.

### 2026-02-09 Hotfix 5 (Hero Fullscreen Video Click Not Opening File Picker)

**Issue observed**:
- In edit mode, clicking the first fullscreen hero media area did not open the file chooser.
- The problem was most visible in the hero section ("big video cover" area).

**Root cause**:
- In `js/editor.js`, the image upload overlay (`.image-edit-overlay`) had no explicit stacking order.
- Hero template contains an existing gradient mask with `z-10`, so clicks were intercepted by that layer instead of the upload overlay click handler.

**Fix implemented**:
- Updated upload overlay style in `enableImageEditing()`:
  - Added `z-index: 20` to ensure overlay is above hero gradient/mask layers.
  - Added `cursor: pointer` for clearer edit affordance.
- Hardened click handling:
  - `overlay` click now uses `preventDefault()` and `stopPropagation()` before calling `handleImageClick(img)`.

**Result**:
- Clicking the hero fullscreen media area in edit mode now reliably opens the local file picker.

### 2026-02-09 Hotfix 6 (Global Media Support: Image + Video)

**Issue observed**:
- Media edit/upload flow was image-only in practice.
- Hero "video cover" and other media slots used image background rendering, so uploading video was unsupported.

**Root cause**:
1. Frontend upload chooser only accepted `image/*`.
2. Backend upload API MIME filter only allowed image types.
3. Template rendering paths for `data-material-img` assumed background images, not video nodes.

**Fix implemented**:
- Updated `js/templates.js`:
  - Added media type detection (`isVideoUrl`) and reusable video layer renderer (`renderVideoLayer`).
  - Upgraded all major media containers (hero, highlights, features, text-image sections, closer look) to render either:
    - image background (`background-image`) or
    - autoplay muted loop `<video>` layer (for video URLs/data URLs).
  - Upgraded gallery item rendering to support both `<img>` and `<video>`.
- Updated `js/editor.js`:
  - Media picker now accepts `image/*,video/*`.
  - Added live media preview applier that switches DOM presentation between image background and video layer.
  - Kept existing `data-material-img` binding path so material structure remains compatible.
- Updated `js/mode-manager.js`:
  - Added `uploadMedia(file)` API (and kept `uploadImage(file)` as backward-compatible alias).
  - Upload payload field switched to `media`.
- Updated `server/routes/upload.js`:
  - Increased upload limit to `100MB`.
  - Extended allowed MIME types to common image + video formats.
  - Endpoint now accepts both `media` (new) and `image` (backward compatibility) form fields.

**Result**:
- Site media slots now support both images and videos in a single editing workflow.
- Existing image-based content remains compatible.

### 2026-02-09 Hotfix 7 (Export/Import Runnable Site ZIP with Media)

**Requirement**:
- Replace editor `Export`/`Import` JSON workflow with full runnable package workflow.
- Package must include HTML/CSS/JS + latest material + media files.

**Implementation**:
- Added backend package APIs (`server/routes/package.js`):
  - `GET /api/package/export`: builds a ZIP snapshot containing:
    - `index.html`
    - `css/`
    - `js/`
    - `material.json` (normalized for package paths)
    - referenced `uploads/` media files
    - `README_PACKAGE.txt`
  - `POST /api/package/import`: accepts package ZIP, extracts `material.json` + `uploads/*`, writes media into server uploads, records media metadata, replaces CMS material.
- Wired API route in `server/index.js`:
  - `app.use('/api/package', packageRoutes);`
- Added `adm-zip` dependency in server.
- Extended frontend mode manager (`js/mode-manager.js`):
  - `exportSitePackage()`
  - `importSitePackage(file)`
  - `reloadOnlineMaterial()`
- Updated editor import/export behavior (`js/editor.js`):
  - `Export` now downloads `site-package-YYYY-MM-DD.zip` via backend package API.
  - `Import` now supports package ZIP import and server refresh.
  - Kept backward compatibility for `.json` import.
  - Package import/export requires **Online mode** to include server-side media.

**Result**:
- Export now produces a runnable static ZIP snapshot with media.
- Import can restore material + media from exported ZIP back into CMS.

### 2026-02-09 Hotfix 8 (Static Viewer Export - Remove CMS Dependencies)

**Issue observed**:
- Exported ZIP contained CMS version of `index.html` with editing scripts (`mode-manager.js`, `editor.js`).
- External `material.json` loading failed under `file://` protocol due to CORS restrictions.
- Media files missing from exported package despite collection logic existing.
- Exported site attempted to initialize CMS features and displayed blank page.

**Root cause**:
1. Export handler directly copied project `index.html` which includes all CMS scripts and ModeManager initialization.
2. Material data loaded via fetch/XHR which browsers block on `file://` protocol.
3. Media collection only searched material strings for `/uploads/` paths, missing files with inconsistent path formats.
4. Full `js/` directory copied including CMS-specific modules not needed for static viewing.

**Fix implemented**:
- Rewrote `server/routes/package.js` export handler:
  - **Dynamically generates static viewer `index.html`**:
    - Material data inlined as `window.__PRELOADED_MATERIAL__` (no fetch required).
    - Only includes rendering scripts: `templates.js`, `section-renderer.js`, `quiz.js`, `main.js`, `scroll-animations.js`, `ai-chat.js`.
    - Excludes CMS scripts: `mode-manager.js`, `editor.js`, `material.js`.
    - Simple initialization: `SectionRenderer.init(material, 'index')` without ModeManager.
    - Navigation bar rendered from material data, no mode-controls injection.
  - **Comprehensive media packaging**:
    - Scans entire `server/uploads/` directory and includes all files in ZIP `uploads/` folder.
    - Removed fragile string-matching collection logic.
  - **Selective JS bundling**:
    - Changed from copying entire `js/` folder to only adding 6 rendering scripts.
  - Updated `README_PACKAGE.txt` to clarify this is a static viewer that works with `file://` protocol.

**Result**:
- Exported ZIP now opens correctly by double-clicking `index.html` (no server required).
- All uploaded media files properly included in package.
- No CMS editing UI or initialization errors.
- Package is truly self-contained and portable for viewing.

### 2026-02-09 Hotfix 9 (Export Media Path Resolution for Online Uploads)

**Issue observed**:
- Export package was generated, but cloud-edited uploaded media still did not render in exported `index.html`.

**Root cause**:
1. Export path normalization converted `/uploads/...` to `uploads/...`.
2. Template URL resolver treated `uploads/...` as a normal relative filename and prefixed `imagesBasePath` (`assets/images/`), producing invalid URLs like:
   - `assets/images/uploads/...`
3. Some online records may store absolute URLs (`http://host/uploads/...`), which were not normalized into package-local paths.

**Fix implemented**:
- Updated `js/templates.js` `getImageUrl()`:
  - `uploads/...` and `./uploads/...` are now treated as direct media paths (no `imagesBasePath` prefix).
- Updated `server/routes/package.js` `toPackageMaterial()`:
  - Added normalization for absolute upload URLs:
    - `http://.../uploads/file.ext` -> `uploads/file.ext`
  - Keeps existing `/uploads/...` -> `uploads/...` normalization.

**Result**:
- Exported static package now correctly resolves and displays uploaded image/video media from cloud editing scenarios.

### 2026-02-09 Hotfix 10 (Reference Citation Jump Works in Export Viewer)

**Issue observed**:
- In exported static package, clicking citation superscripts (e.g. `[1]`) no longer scrolled to footer references.

**Root cause**:
- Citation click handler was wired via `EditorSystem` path.
- Export viewer intentionally excludes `editor.js`, so reference click delegation was never attached.

**Fix implemented**:
- Moved citation click interaction wiring to `js/section-renderer.js` as shared runtime behavior:
  - Added internal `setupCitationClickHandlers()` with one-time delegated click binding.
  - Added `handleCitationClick()` to:
    - locate `.ref-cite`,
    - smooth-scroll to `#ref-{id}`,
    - apply temporary `ref-highlight` animation class.
- Replaced `EditorSystem`-dependent initialization call with renderer-owned setup call.

**Result**:
- Citation jump/highlight behavior is now consistent between CMS preview and exported static viewer.

### Production Considerations
- Change JWT_SECRET in .env
- Change CMS_PASSWORD in .env
- Use HTTPS for API endpoints
- Configure MySQL for remote connections
- Set up proper file upload limits
- Enable MySQL JSON validation

## Conclusion

Version 0.3 successfully transforms the Apple Style Website Engine into a production-ready CMS with flexible editing modes, template-driven architecture, and seamless offline/online workflows. The dual-axis mode system provides unprecedented flexibility for content creators, while the template registry ensures consistency and extensibility.
