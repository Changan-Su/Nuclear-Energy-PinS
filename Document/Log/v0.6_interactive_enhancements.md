# Version 0.6 Development Log - Interactive Enhancements

## 开发时间
2026-02-12

## 版本目标
三项核心功能增强：
1. "Learn More" 按钮卡片翻转动画 + 详情编辑
2. 图片位置调整和缩放控制
3. LaTeX 数学公式渲染支持

## 功能一：卡片翻转动画（Learn More）

### 需求
- Highlights 区域中每个标签页的 "Learn More" 按钮，点击后应展示对应的详细内容
- 翻转动画需要符合 Apple 官网风格（流畅的 3D 翻转）
- 详情内容在编辑模式下可直接编辑

### 实现方案

**CSS 3D 翻转**:
- 使用 `perspective: 1200px` + `transform: rotateY(180deg)` 实现纵向翻转效果
- 过渡曲线 `cubic-bezier(0.4, 0.0, 0.2, 1)` 提供 Apple 风格的流畅感
- `backface-visibility: hidden` 确保正反面互不干扰

**DOM 结构调整**:
- 每个 tab content 内部包裹一个 `.flip-card` 容器
- 正面 `.flip-card-front`：原有内容（图片+标题+描述+按钮）
- 反面 `.flip-card-back`：详情内容（标题+分割线+详情文字+关闭按钮）

**数据层**:
- `material.json` 每个 highlight tab 新增 `detail` 字段，存储详情文本
- 详情文本支持 LaTeX 语法（配合功能三）

**交互逻辑**:
- 点击 "Learn More" 按钮 → `.flip-card` 添加 `.flipped` 类 → 触发 CSS 翻转
- 点击关闭按钮（X）→ 移除 `.flipped` 类 → 翻回正面
- 事件绑定在 `section-renderer.js` 的 `initializeFlipCards()` 中

### 文件变更
- `js/templates.js` — `tabbedContentTemplate()` 重构，增加翻转卡片结构
- `css/input.css` — 新增 `.flip-card`, `.flip-card-inner`, `.flip-card-front`, `.flip-card-back` 样式
- `material.json` — 每个 highlight tab 增加 `detail` 字段（含 LaTeX 示例内容）
- `js/section-renderer.js` — 新增 `initializeFlipCards()` 函数

---

## 功能二：图片位置与缩放控制

### 需求
- 编辑模式下，所有背景图片支持调整 X/Y 位置和缩放比例
- 调整参数持久化到 material 数据中
- 视图模式下控件隐藏

### 实现方案

**控件设计**:
- 底部居中的 floating 控制条（Apple 风格毛玻璃效果）
- 三个 range slider：X（0-100%）、Y（0-100%）、Zoom（50-300%）
- Reset 按钮恢复默认值（50%, 50%, 100%）

**数据结构**:
- 在 `images` 对象下新增 `position` 子对象：`{ x: 50, y: 50, scale: 100 }`
- 对于 card-grid 模板，使用 `imagePosition` 字段

**实时预览**:
- `input` 事件 → 实时更新 `background-position` 和 `background-size`
- `change` 事件 → 持久化到 material 数据

**CSS 可见性**:
- `.img-position-controls` 默认 `display: none`
- `body.edit-mode .img-position-controls` → `display: flex`

### 模板适配
所有带 `data-material-img` 的模板均已适配：
- Hero template（视频封面）
- Tabbed content template（高亮图片）
- Card grid template（卡片图片）
- Text-image-left / text-image-right（文图组合）
- Accordion template（closer look 图片）

### 文件变更
- `js/templates.js` — 所有模板函数增加 `imgPos` 解析逻辑，使用 `background-size: ${scale}%` 和 `background-position: ${x}% ${y}%`
- `js/section-renderer.js` — 新增 `initializeImagePositionControls()`, `applyImagePosition()`, `saveImagePosition()`, `getNestedValue()`, `setNestedValue()` 函数
- `css/input.css` — 新增 `.img-position-controls` 样式系统（毛玻璃背景、range slider 自定义主题、reset 按钮）

---

## 功能三：LaTeX 数学公式渲染

### 需求
- 文本内容支持 LaTeX 语法的数学公式显示
- 兼容行内公式 `$...$` 和独立公式 `$$...$$`
- 支持 `\(...\)` 和 `\[...\]` 语法

### 实现方案

**KaTeX 集成**:
- 引入 KaTeX v0.16.11（CDN）：CSS + JS + auto-render 插件
- 使用 `defer` 加载，不阻塞页面渲染

**渲染模块** (`js/latex-renderer.js`):
- `renderAll()`: 渲染页面中所有 `[data-material]` 和 `.latex-content` 元素中的 LaTeX
- `renderElement(el)`: 渲染指定元素
- `renderString(text)`: 将包含 LaTeX 的字符串转换为 HTML
- 自动等待 KaTeX 加载完成（轮询机制，最多 5 秒）

**Delimiter 配置**:
```javascript
delimiters: [
  { left: '$$', right: '$$', display: true },
  { left: '$', right: '$', display: false },
  { left: '\\(', right: '\\)', display: false },
  { left: '\\[', right: '\\]', display: true }
]
```

**集成点**:
- `section-renderer.js` 的 `reinitializeComponents()` 中调用 `LatexRenderer.renderAll()`
- 每次内容重渲染后自动触发 LaTeX 渲染

### 示例内容
material.json 中的 detail 字段已包含 LaTeX 示例：
- Efficiency: `$200\,\text{MeV}$`
- Zero Carbon: `$12\,\text{g CO}_2/\text{kWh}$`, `$820\,\text{g CO}_2/\text{kWh}$`
- Safety: `$1 \times 10^{-7}$`

### 文件变更
- `js/latex-renderer.js` — **新增文件**，LaTeX 渲染模块
- `index.html` — 引入 KaTeX CDN（CSS + JS + auto-render），加载 `latex-renderer.js`
- `js/section-renderer.js` — `reinitializeComponents()` 增加 `LatexRenderer.renderAll()` 调用

---

## 技术亮点

### 1. CSS 3D 翻转
- 使用纯 CSS 实现，无需 JS 动画库
- `transform-style: preserve-3d` 保持 3D 空间
- 适当的 `perspective` 值提供自然的深度感

### 2. 数据驱动的图片控制
- 位置/缩放参数存储在 material JSON 中，支持 undo/redo
- 实时预览 + 延迟保存的双轨策略

### 3. 惰性 LaTeX 渲染
- KaTeX 使用 defer 加载，不影响首屏渲染
- 渲染器内部有轮询等待机制，确保 KaTeX 就绪后才执行
- `throwOnError: false` 确保格式错误的公式不会破坏页面

## 文件变更清单

### 新增文件
- `js/latex-renderer.js` — LaTeX 渲染模块

### 修改的文件
- `js/templates.js` — 翻转卡片结构 + 图片位置参数支持
- `js/section-renderer.js` — 翻转卡片初始化 + 图片控制初始化 + LaTeX 渲染
- `css/input.css` — 翻转动画样式 + 图片控制条样式
- `index.html` — KaTeX CDN 引入 + latex-renderer.js 加载 + 内嵌数据更新
- `material.json` — highlight tabs 增加 detail 字段

### 更新的文档
- `Document/Log/v0.6_interactive_enhancements.md`（本文件）

## Bug修复 (2026-02-13)

### 问题：Grid Card 不显示
**症状**: Features 部分的三个卡片（Benefits 区域）在页面上不可见。

**根本原因**:
1. 在 `cardGridTemplate` 中，每个卡片被包裹在 `<div class="fade-in-up">` 中用于滚动动画
2. `fade-in-up` 类设置了 `opacity: 0` 和 `transform: translateY(20px)`
3. 外层 div 没有明确高度，导致：
   - 即使 flip-card 包装器设置了 `h-[560px]`，外层 div 可能崩塌为 0 高度
   - Intersection Observer 无法正确检测到元素进入视口
   - 动画未触发，卡片保持 `opacity: 0` 不可见

**修复方案**:
- 将 `h-[560px]` 高度类从内层 flip-card 包装器移到外层 `fade-in-up` div
- flip-card 包装器改用 `h-full` 继承父容器高度
- 移除 frontHtml 中冗余的 transition-delay（外层已有）

**修改文件**:
- `js/templates.js` — `cardGridTemplate()` 函数，调整高度分配逻辑

**技术要点**:
- CSS Intersection Observer 依赖元素的实际尺寸来判断是否进入视口
- 动画容器必须有明确的尺寸，否则会导致布局崩塌
- Tailwind 的 flex/grid 子项高度继承需要父容器有确定高度

---

## 参考的前置工作
- v0.5: SVG Template Gallery
- v0.4: Reference Citation System
- v0.3: CMS Online Editing System
- v0.2: Frontend Build
- v0.1: Initial Setup

---

## Bug修复 (2026-02-13) - 离线模式 Export/Import 失效

### 问题现象
- 离线模式点击 Export 会被直接拦截，无法导出当前编辑内容
- Import 在某些提前返回分支不会清空文件选择器，重复导入时看起来像“按钮无效”

### 根因分析
1. `exportMaterial()` 仅支持在线导出 ZIP 包，离线分支直接 `alert + return`
2. `handleImport()` 的 input reset 放在函数末尾；一旦在 `try` 内提前 `return`，重置逻辑不会执行

### 修复方案
- 为离线模式增加完整 ZIP 导出：
  - 读取当前 `ModeManager.getMaterial()`，构建 `site-package-YYYY-MM-DD.zip`
  - 导出内容包含 `index.html`、`material.json`、渲染脚本、样式以及可访问到的引用素材
- 为导入流程增加 `finally` 统一收口：
  - 无论导入成功、失败或提前返回，都会重置 `event.target.value`
  - 保证同一文件可重复触发导入
- 新增离线 ZIP 导入流程：
  - 解析包内 `material.json`
  - 将 `uploads/*` 文件转为 `data:` URL 并回填到 material，确保离线可直接显示

### 修改文件
- `js/editor.js`

---

## 功能增强 (2026-02-14) - Card Grid 居中排布 + Apple 风格详情展开 + 全模板详情图片增强

### 本次目标
- Card Grid 每行剩余卡片不再左对齐，改为居中排布。
- Card Grid 的详情不再局限在单卡翻转区域，而是以 Apple 风格从卡片位置展开到整个 Grid 区域。
- 所有支持 `detail` 的模板，详情顶部支持复用前置主图作为 banner，并支持在详情末尾插入一张可配置图片。

### 实现内容

1. **Card Grid 居中排布**
   - 将 `card-grid` 的容器由 `grid` 改为 `flex + flex-wrap + justify-center`。
   - 新增 `.card-grid-item` 规则，在桌面端按三列宽度计算，保留空位时自动居中整行。
   - 修改文件：
     - `js/templates.js`
     - `docs/js/templates.js`
     - `css/input.css`
     - `css/styles.css`
     - `docs/css/styles.css`

2. **Card Grid 详情 Apple 风格展开**
   - `card-grid` 从「卡内 flip back」改为「overlay 面板」方案：
     - 点击 `Learn more` 后，从当前卡片位置平滑扩展到整个 card-grid 区域。
     - 关闭时反向回弹到原卡片位置。
   - 新增交互初始化 `initializeDetailOverlays()`，支持：
     - 打开/关闭动画
     - 背景遮罩点击关闭
     - `Esc` 关闭
     - 打开时锁定页面滚动
   - 新增样式：
     - `.card-grid-detail-layer`
     - `.card-grid-detail-panel`
     - `.card-grid-detail-backdrop`
     - 内容入场淡入位移动画
   - 修改文件：
     - `js/section-renderer.js`
     - `docs/js/section-renderer.js`
     - `css/input.css`
     - `css/styles.css`
     - `docs/css/styles.css`

3. **所有 detail 支持 banner 与末尾图片**
   - 在模板公共层新增：
     - `renderDetailMedia()`
     - `renderDetailContent()`
   - `renderFlipWrapper()` 新增参数：
     - `bannerImageUrl` / `bannerImagePath`
     - `detailEndImageUrl` / `detailEndImagePath`
   - 覆盖模板：
     - `tabbed-content`
     - `card-grid`（overlay detail）
     - `text-image-left`
     - `text-image-right`
     - `accordion`
   - 修改文件：
     - `js/templates.js`
     - `docs/js/templates.js`

4. **数据结构扩展**
   - 在 `docs/material.json` 增加 `detailEndImage` 字段（空字符串默认值），覆盖：
     - `highlights.items[*]`
     - `features.cards[*]`
     - `safety` / `sustainability` / `innovation`

### 兼容性说明
- 其它模板仍保留原 flip 机制，仅增强 detail 内容结构（banner + end image）。
- `card-grid` 的详情入口仍受 `flipEnabled` 控制；`flipEnabled: false` 的卡片不会出现详情按钮与 overlay 数据源。

### 后续修正补丁（2026-02-14）
- **问题1：Card Grid 需要保持最多 3 卡/行**
  - 在卡片项上补充显式宽度类：`md:w-[calc((100%-4rem)/3)]` + `md:max-w-[calc((100%-4rem)/3)]`。
  - 保障在不同视口与样式覆盖情况下仍严格维持桌面 3 列上限。

- **问题2：Card Grid Details 打开后内容无法正常加载**
  - 根因：触发按钮与隐藏详情源共用了 `data-detail-source`，查询时误取到按钮节点，导致 overlay 注入内容错误。
  - 修复：拆分属性命名：
    - 按钮：`data-detail-source-key`
    - 隐藏详情源：`data-detail-content-source`
  - 同步更新 `initializeDetailOverlays()` 查询逻辑。
  - 二次加固：改为从当前被点击的 `cardItem` 内直接查询隐藏详情源，避免跨 section/key 查询引发的错配或空读。

- **补丁修改文件**
  - `js/templates.js`
  - `docs/js/templates.js`
  - `js/section-renderer.js`
  - `docs/js/section-renderer.js`

---

## 功能增强 (2026-02-14) - docs Grid Card 填充 Renewable 章节

### 需求
- 将 `PinS Project.docx` 中 Renewable 部分内容填充到 `docs` 的 Grid Card。
- 按 `Subtitle / Key Sentence / Details` 对齐现有数据结构，并保持换行与数学公式渲染可用。
- 本次暂不处理图片。

### 实现方案
1. **字段映射**
   - Grid Card 实际字段为：`title`、`description`、`detail`。
   - 对应关系：
     - `Subtitle -> title`
     - `Key Sentence -> description`
     - `Details -> detail`
2. **内容重构**
   - 将 Renewable 章节拆分为 3 张卡片：
     - Solar Power (Photovoltaic)
     - Wind Power
     - Hydroelectric Power
   - 每张卡片启用翻转详情（`flipEnabled: true`），并统一 `cta: Learn more`。
3. **公式与排版**
   - 在 `detail` 中使用 KaTeX 兼容格式（`$$...$$`）写入关键公式：
     - Solar: `$$E = hf$$`
     - Wind: `$$E_k = \\frac{1}{2}mv^2$$`, `$$m = \\rho V$$`, `$$P_{\\text{wind}} = \\frac{1}{2}\\rho A v^3$$`
     - Hydro: `$$U = mgh$$`
   - 使用段落换行（`\n\n`）确保详情面板阅读结构清晰。

### 修改文件
- `docs/material.json`
- `docs/index.html`（同步内嵌 fallback 数据，避免本地读取失败时回退旧内容）

### 修正说明（同日）
- 用户反馈需“保留原文，不要改写”，且 Renewable 分段不止 3 段。
- 已将 `docs` Grid Card 从 3 张扩展为 6 张，按原文分段写入：
  - `Intro`
  - `Solar power`
  - `2. Wind power`
  - `3. Hydroelectric power`
  - `Generator physics:`
  - `4. Geothermal Energy`
- 已移除此前概述式改写文案，改为文档原文逐段填充（含原句式与参考链接）。

### 二次调整（按用户拆分规则）
- 按“数字开头标题拆分卡片”规则，最终调整为 5 张卡片：
  - `1. Solar power`
  - `2. Wind power`
  - `3. Hydroelectric power`（并入 `Generator physics` 内容）
  - `4. Geothermal Energy`
  - `5.  Comparison of Energy Sources`
- 删除 `Intro` 卡片，将 Intro 重点摘要放入 `features.subheadline`（Renewable 标题下方字段）。

---

## 功能修正 (2026-02-13) - 首个 Section 详情文本换行与阅读排版优化

### 问题现象
- 首个内容区块（Tabbed Content）卡片反面的 `detail` 文本在渲染后换行/空行不明显。
- 参考 `nuclear individual section.docx` 的章节化写法后，现有页面不利于长段科学内容阅读。

### 根因分析
1. 详情文本以普通 HTML 文本节点输出，浏览器会折叠连续空白字符与换行。
2. 反面详情区域虽然支持滚动，但没有针对“多段落+长文本”的排版策略。

### 修复方案
- 在详情容器增加专用样式类 `.detail-rich-text`。
- 为该类启用 `white-space: pre-line`，保留文本中的换行语义（兼容文档式段落）。
- 增加 `word-break/overflow-wrap`，避免长词或公式导致布局溢出。
- 保持现有 LaTeX 渲染链路不变，确保公式与文本可同时正常显示。

### 修改文件
- `js/templates.js`
- `css/input.css`
- `css/styles.css`（重新构建产物）

---

## Bug修复 (2026-02-13) - Section 名称修改后右上角快速跳转不更新

### 问题现象
- 编辑侧边栏里修改 Section 名称后，右上角快速跳转（导航）文案不变化，表现为“title 改不了”。

### 根因分析
1. `updateSectionName()` 在更新内存数据后只派发了 `nav-update` 事件。
2. 项目中没有任何地方监听 `nav-update`，因此导航文案不会被实际更新。

### 修复方案
- 在 `updateSectionName()` 内改为直接同步 DOM：
  - 立即更新所有匹配 `data-section-id` 的 `.nav-link` 文案。
  - 同步更新侧边栏当前 Section 名称，避免界面状态不一致。
- 保留原有数据写回流程（`section.name` + `updateMaterialInMemory`），确保保存链路不变。

### 修改文件
- `js/editor.js`

---

## Bug修复 (2026-02-13) - 保存到文件夹后快速跳转仍显示旧文案

### 问题现象
- 编辑模式中修改 Section 名称后，当前页面右上角快速跳转可更新。
- 但执行 `Save All` 保存到本地文件夹后，打开导出的查看版页面，右上角快速跳转仍是旧文案。

### 根因分析
1. 文件夹导出链路使用 `offline-site-saver.js -> generateViewerHtml()` 生成查看版 `index.html`。
2. 该模板导航使用 `material.index.nav.links` 静态渲染，不读取 `config.sections[].name`。
3. 因为 Section 改名写入的是 `config.sections[].name`，导出后导航不会反映这类改动。

### 修复方案
- 将导出查看版导航结构改为与主站一致的动态容器：
  - 使用 `#nav-links-container` 作为占位容器。
  - 由 `section-renderer.js` 的 `updateNavLinks()` 按 `config.sections` 生成快速跳转项。
- 同步修正 ZIP 导出链路（`editor.js` 内 `generateOfflineViewerHtml()`），避免两条导出路径行为不一致。

### 修改文件
- `js/offline-site-saver.js`
- `js/editor.js`

---

## 功能修正 (2026-02-13) - 移动端竖屏保持横屏比例布局

### 问题现象
- 手机竖屏下页面会按窄屏断点重新排版，视觉比例与横屏设计偏差较大。
- 用户希望优先保持横屏视觉比例，允许在竖屏看到更长的纵向内容。

### 实现方案
1. **新增动态 viewport 管理器**
   - 在页面初始化时检测是否为移动端设备。
   - 当设备处于竖屏时，按 `16:9` 计算虚拟布局宽度：`width = max(960, innerHeight * 16/9)`。
   - 将 `meta viewport` 动态设置为该宽度，让浏览器对整体布局做等比缩放，尽量维持横屏版式比例。
2. **横屏与桌面保持原行为**
   - 移动端横屏、非移动端统一使用 `width=device-width`，避免影响桌面与常规横屏体验。
3. **方向变化实时更新**
   - 监听 `orientationchange`、`resize`、`pageshow`，保证旋转或回到页面时自动重算。

### 修改文件
- `js/viewport-manager.js`
- `Examples/js/viewport-manager.js`
- `index.html`
- `Examples/index.html`

---

## 功能增强 (2026-02-13) - Examples 首个 Tabbed Content 章节化填充（基于 section2 文档）

### 需求
- 按用户提供的 `nuclear individual section2.docx` 填充 `Examples` 目录中的首个 Tabbed Content 页面。
- 不同章节对应不同按钮，并自动对齐 `subtitle / Key Sentence / Details`。
- 尽可能保留原文，并将公式转换为可在站点中渲染的格式。

### 实现方案
1. **数据映射策略**
   - 目标模板采用 `highlights.items` 数据结构，实际字段为：
     - `tab`（按钮标题）
     - `title`（对应 subtitle）
     - `description`（对应 Key Sentence）
     - `detail`（对应 Details）
   - 将文档中的 5 个章节分别映射为 5 个 tab。

2. **章节拆分与按钮化**
   - 按原文章节结构拆分：
     - The Physics of Nuclear Fission
     - The Chain Reaction
     - How a Nuclear Reactor Controls Fission
     - Nuclear Fission in History and Safety
     - Future Fission Technologies
   - `tabs` 与 `items[].tab` 同步更新为章节按钮文案，保证前台切换一致。

3. **公式适配**
   - 依据现有 KaTeX 渲染链路（`$...$` / `$$...$$`），将关键公式写入 `detail`：
     - 典型裂变方程（U-235 示例）
     - 质能关系式 `E=mc^2`
     - 链式反应中 `k` 的概念表达式及 `$k<1$/$k=1$/$k>1$`
   - 兼容当前模板反面详情区的 `.latex-content` 渲染。

### 修改文件
- `Examples/material.json`

### 结果
- `Examples` 首个 Tabbed Content 已从原先 3 个占位项扩展为 5 个章节按钮。
- 每个章节已完成 `subtitle -> title`、`Key Sentence -> description`、`Details -> detail` 的自动对应填充。
- 关键公式已改为站点可渲染格式，保留原文语义并增强可读性。

---

## Bug修复 (2026-02-13) - Examples 页面未读取最新 material.json

### 问题现象
- 直接打开 `Examples/index.html` 后，页面仍显示旧内容，`Examples/material.json` 中的新章节数据未生效。

### 根因分析
1. `Examples/index.html` 内嵌了旧版 `window.__PRELOADED_MATERIAL__`。
2. 启动时 `SectionRenderer.init()` 直接使用内嵌对象渲染，绕过外部 `material.json`。

### 修复方案
- 调整初始化逻辑为：
  - 优先加载 `./material.json`（`fetch`，并禁用缓存）。
  - 若 `fetch` 在部分 `file://` 场景失败，则回退到 `XMLHttpRequest` 读取本地文件。
  - 仅当两者都失败时，才回退内嵌 `__PRELOADED_MATERIAL__`。

### 修改文件
- `Examples/index.html`

---

## Bug修复 (2026-02-13) - 生成到文件夹/ZIP 后仍可能读取旧内嵌数据

### 问题现象
- 通过离线保存（`Save All`）生成的站点目录，或离线 `Export ZIP` 生成的 `index.html`，在后续仅修改 `material.json` 时，页面可能仍显示旧内容。

### 根因分析
1. 生成器输出的 `index.html` 默认以 `window.__PRELOADED_MATERIAL__` 直接初始化渲染。
2. 外部 `material.json` 未作为首选数据源，导致“改 JSON 不生效”。

### 修复方案
- 对两条生成链路统一改造为：
  - 优先读取 `./material.json`（`fetch` + `no-store`）。
  - `file://` 场景下 `fetch` 失败时，自动回退到 `XMLHttpRequest`。
  - 两者都失败时才使用内嵌 `__PRELOADED_MATERIAL__` 兜底。
- 同步将离线 README 文案更新为“外部 material.json 为主，内嵌仅兜底”。

### 修改文件
- `js/offline-site-saver.js`
- `js/editor.js`

---

## 功能修正 (2026-02-13) - Examples 公式渲染、详情滚动与引用跳转完善

### 问题
- 部分公式在详情面板显示为未渲染文本/错误样式。
- 长详情文本在卡片反面可能超出可视区域，不便阅读。
- 章节内容中的参考文献未按项目引用格式接入，无法直接跳转到底部 Reference。

### 修复
1. **公式渲染稳定性**
   - 将高风险公式写法改为更稳的 KaTeX 表达（如裂变方程中的能量项改为 `Q`）。
   - 在 LaTeX 渲染器新增 `katex-error` 恢复逻辑：对常见转义问题进行归一化并二次渲染尝试。
2. **详情面板滚动**
   - Tabbed Content 反面详情容器改为固定区域内滚动（`latex-content` 强制 `overflow-y-auto` + `max-height:100%`）。
3. **引用系统接入**
   - 在章节 `detail` 中插入项目兼容引用标记：
     - `<sup class="ref-cite" data-ref-id="N">[N]</sup>`
   - 同步填充 `footer.reference.items` 为对应文献条目，支持点击引用平滑跳转并高亮 Reference。

### 修改文件
- `Examples/material.json`
- `Examples/js/templates.js`
- `Examples/js/latex-renderer.js`
- `js/templates.js`
- `js/latex-renderer.js`

---

## 功能增强 (2026-02-13) - Tabbed/Grid/Accordion 条目动态增减

### 需求
- `Tabbed Content` 支持增减 tab 按钮与对应内容项（不再固定 4 个）。
- `Grid Card` 支持增减 card 数量。
- `Accordion` 支持增减条目数量。
- 编辑模式下直接在模板区域完成操作，并保持 undo/redo 与保存链路一致。

### 实现方案
1. **Tabbed Content 数组化 + 旧结构兼容**
   - `tabbedContentTemplate()` 改为优先读取 `highlights.items` 数组。
   - 新增兼容转换：若 `items` 不存在，则从旧结构 `tabs + efficiency/zeroCarbon/safety/reliability` 生成运行时条目，保证旧数据可继续渲染。
   - 新路径统一为 `highlights.items.{index}.*`，内联编辑和 flip 配置均可直接写回数组结构。

2. **编辑模式内嵌集合控件**
   - 在 `editor.js` 新增集合编辑器逻辑：
     - `enableCollectionEditors()` / `disableCollectionEditors()`
     - `handleAddCollectionItem()` / `handleDeleteCollectionItem()`
   - 三类模板在编辑模式下新增：
     - `+ Add Tab`
     - `+ Add Card`
     - `+ Add Item`
   - 每个条目带独立删除按钮，且设置最小保留数量（至少 1 项）。
   - 所有增删都接入既有流程：`captureSnapshot -> updateMaterialInMemory -> render -> refresh`。

3. **默认数据与新增 Section 初始化**
   - 新增 `createDefaultCollectionItem()`，为 tab/card/accordion 定义可立即编辑的默认字段。
   - 新增 `createDefaultSectionData(template)`，保证通过 Add Section 创建这三类模板时，不会出现空模板。

4. **交互隔离与结构标记**
   - `section-renderer.js` 中 tab 切换改为 section 内作用域，避免全局 `.tab-content` 串扰。
   - 三类模板增加 `data-collection-*` 标记，供编辑器精确定位集合容器和条目节点。

### 兼容与修正说明
- 为避免历史内容丢失，旧的 highlights 四 key 结构仍保留读取兼容。
- 基线数据补充了 `highlights.items`（`index.html` 与 `material.json`），后续编辑将优先写入新结构。

### 修改文件
- `js/templates.js`
- `js/editor.js`
- `js/section-renderer.js`
- `index.html`
- `material.json`

### 修正说明
- 初版修复将离线 Export 处理为 JSON 下载，无法满足“完整可运行站点压缩包”目标。
- 已二次修正为离线导出 ZIP 包，结构与在线 package 导出保持一致（`index.html`、`material.json`、渲染脚本、样式与可读取素材）。
- 同时新增离线 ZIP 导入：读取 `material.json` 并将 `uploads/*` 媒体自动转为 `data:` URL 内嵌，确保离线可直接显示。

---

## Bug修复 (2026-02-13) - Hero 更换媒体后占位文案未隐藏

### 问题现象
- 在 Hero 区域替换图片或视频后，背景媒体已更新，但 `Video Background Placeholder` 文案仍然可见。

### 根因分析
1. `heroTemplate()` 中占位文案区域是固定渲染，未根据 `hero.images.videoCover` 是否有值进行条件隐藏。
2. 编辑模式中 `applyMediaPreview()` 只更新背景图/视频节点，不会同步切换占位文案显示状态。

### 修复方案
- 模板层修复（首次渲染场景）：
  - 在 `heroTemplate()` 新增 `hasHeroMedia` 判断。
  - 当存在媒体时，为占位容器添加 `hidden`，并加入 `data-hero-media-placeholder="true"` 标记。
- 编辑器实时修复（编辑中切换场景）：
  - 在 `editor.js` 新增 `syncHeroMediaPlaceholder()`。
  - `applyMediaPreview()` 在图片和视频分支都调用该函数，确保替换后立即隐藏占位文案，清空媒体时再恢复显示。

### 修改文件
- `js/templates.js`
- `js/editor.js`

---

## Bug修复 (2026-02-13) - 离线刷新后媒体丢失（文字仍在）

### 问题现象
- 离线编辑后刷新页面，文本改动仍可恢复，但图片/视频改动丢失。

### 根因分析
1. 离线草稿此前仅使用 `localStorage` 持久化。
2. 文本体积小，通常可成功写入；媒体在离线模式会被转为 `data:`（base64）后体积迅速膨胀。
3. 超出浏览器配额后会写入失败，导致刷新只能读取“上一次成功保存”的草稿，形成“文字在、媒体没了”。

### 修复方案
- 将离线草稿存储升级为 **IndexedDB 主存储**，并保留 `localStorage` 作为兜底。
- 启动时优先读取 IndexedDB；若仅存在旧 `localStorage` 草稿，会自动迁移到 IndexedDB。
- 离线保存失败时增加可见告警（`alert`），提示用户立即导出 ZIP 备份或切换在线上传媒体，避免静默丢失。
- 继续保留离线自动保存路径（编辑中实时写草稿）。

### 修改文件
- `js/mode-manager.js`
- `js/editor.js`

---

## Bug修复 (2026-02-13) - 离线导出缺少完整脚本和初始化逻辑

### 问题现象
- 离线模式导出的 ZIP 包打开后，前端显示不完整或部分功能异常。

### 根因分析
1. `getStaticPackageFiles()` 缺少 `mode-manager.js`、`editor.js`、`material.js`。
2. 导出 HTML 的脚本加载顺序和初始化逻辑与原 `index.html` 不一致。
3. 缺失的脚本导致部分依赖初始化链断裂（例如导航、滚动动画、AI 聊天等）。

### 修复方案
- 将 `mode-manager.js`、`editor.js`、`material.js` 加入静态打包清单。
- 调整导出 HTML 的脚本加载顺序，与原项目 `index.html` 保持一致。
- 初始化逻辑改为调用 `ModeManager.init()`（与原项目完全对齐）。

### 修改文件
- `js/editor.js`

---

## 功能增强 (2026-02-13) - 离线模式本地文件夹持久化

### 问题背景
- 离线模式使用 IndexedDB/localStorage 保存草稿,大文件(base64 媒体)会超出浏览器配额导致保存失败
- 用户无法直接访问保存的内容,只能通过导出 ZIP 才能获得完整站点
- 缺乏真正的本地文件系统持久化能力

### 需求
- 允许用户选择一个本地文件夹作为工作目录
- 保存时将完整站点(纯查看版)写入到文件夹
- 重新打开页面时自动从授权文件夹加载 material.json
- 实现真正的本地持久化,不受浏览器存储配额限制

### 实现方案

#### 技术选型
- 使用 **File System Access API** (Chrome 86+, Edge 86+)
- 用户首次保存时选择工作文件夹并授权
- 权限信息存储在 IndexedDB 中(仅存储句柄,不存储内容)

#### 架构设计

**工作流程**:
1. 用户在带编辑功能的 index.html 中编辑内容
2. 点击 "Save All" 按钮
3. 首次保存时弹出文件夹选择对话框
4. 将纯查看版站点写入到选定文件夹
5. 重新打开编辑器时,自动从文件夹加载 material.json
6. 继续编辑,保存时更新文件夹内容

**保存内容**:
- `index.html`: 纯查看版(无编辑器、无在线功能)
- `material.json`: 内容数据
- `uploads/`: 用户上传的媒体文件
- `css/styles.css`: 样式文件
- `js/`: 核心展示脚本(templates.js, section-renderer.js 等,但不包括 editor.js, mode-manager.js)
- `README.txt`: 使用说明

**数据处理**:
- 自动提取 `data:` URL 并转换为实际文件
- 规范化路径(绝对 URL → 相对路径)
- 收集所有引用的资源文件

#### 新增文件

**1. `js/folder-permission-manager.js`** - 文件夹权限管理
- `requestFolderPermission()`: 弹出文件夹选择对话框
- `saveFolderHandle()`: 保存句柄到 IndexedDB
- `getFolderHandle()`: 从 IndexedDB 读取句柄
- `verifyPermission()`: 验证权限是否有效

**2. `js/file-system-writer.js`** - 文件系统读写工具
- `writeTextFile()`: 写入文本文件
- `writeBinaryFile()`: 写入二进制文件(Blob)
- `batchWriteFiles()`: 批量写入文件
- `readTextFile()`: 读取文本文件

**3. `js/offline-site-saver.js`** - 离线站点保存器
- `saveCompleteOfflineSite()`: 主入口,保存完整站点
- `loadMaterialFromFolder()`: 从文件夹加载 material.json
- `generateViewerHtml()`: 生成纯查看版 HTML
- `extractDataUrls()`: 提取 data: URL 并转换为文件

#### 修改的文件

**1. `js/mode-manager.js`**
- 修改 `loadMaterial()`: 优先从授权文件夹加载,回退到 IndexedDB/内嵌 JSON
- 修改 `updateMaterialInMemory()`: 移除自动保存逻辑

**2. `js/editor.js`**
- 修改 `saveAll()`: 集成文件夹保存流程,显示进度
- 新增 `handleSelectFolder()`: 处理文件夹选择
- 新增 `updateFolderStatusDisplay()`: 更新文件夹状态显示
- 修改 `createEditToolbar()`: 添加文件夹相关 UI

**3. `index.html`**
- 引入三个新模块: folder-permission-manager.js, file-system-writer.js, offline-site-saver.js

### UI 改进

**编辑工具栏新增**:
- 文件夹状态显示(显示当前文件夹名称)
- Select Folder 按钮(选择/更换工作文件夹)
- 保存进度显示(0-100%)

### 兼容性处理

- 检查浏览器支持 File System Access API
- 不支持时提示使用 Chrome 86+ 或 Edge 86+
- 保留 Export/Import ZIP 作为备选方案

### 技术亮点

1. **真正的本地持久化**: 不受浏览器存储配额限制,支持大文件
2. **数据 URL 自动提取**: 自动转换 base64 为实际文件
3. **双版本设计**: 编辑版(功能完整) vs 查看版(纯展示)
4. **权限持久化**: 句柄保存在 IndexedDB,自动恢复权限

### 使用说明

**首次使用**:
1. 进入离线编辑模式
2. 点击 "Save All"
3. 选择工作文件夹
4. 等待保存完成

**后续使用**:
1. 重新打开编辑器
2. 自动从文件夹加载
3. 继续编辑
4. Save All 自动更新

**查看保存的站点**:
- 打开文件夹中的 index.html
- 纯查看版,无编辑功能

### 文件变更清单

#### 新增文件
- `js/folder-permission-manager.js`
- `js/file-system-writer.js`
- `js/offline-site-saver.js`

#### 修改的文件
- `js/mode-manager.js`
- `js/editor.js`
- `index.html`

#### 更新的文档
- `Document/Log/v0.6_interactive_enhancements.md`(本文件)

---

## Bug修复 (2026-02-13) - 导出/落盘站点缺失静态资源

### 问题现象
- 生成后的站点目录仅包含 `index.html`、`material.json` 等少量文件，缺少 `css/` 与 `js/`。
- 打开导出页面时样式丢失、区块不渲染，只显示顶部基础文本链接。

### 根因分析
1. 静态资源收集流程依赖 `fetch('./path')` 读取本地资源。
2. 在部分 `file://` 场景中，`fetch` 读取本地文件失败，导致资源被静默跳过。

### 修复方案
- 为离线文件夹保存器新增 `fetch + XHR` 双通道读取：
  - `fetch` 失败时，回退到 `XMLHttpRequest`（接受 `status=0` 的 `file://` 返回）。
- 为 ZIP 打包资源读取增加同样的 XHR 回退，避免导出包缺文件。
- 为文件夹保存新增必需文件校验（`css/styles.css`、`js/templates.js`、`js/section-renderer.js`）：
  - 缺失时直接返回错误并提示用户通过本地 server 运行后再保存。

### 修改文件
- `js/offline-site-saver.js`
- `js/editor.js`

### 后续修复补丁（媒体加载）
- 选择本地文件夹后，虽然 `material.json` 可加载，但 `uploads/*` 媒体仍按当前站点根路径请求，导致图片/视频不显示。
- 已在 `loadMaterialFromFolder()` 增加文件夹媒体内联：自动将相对媒体路径读取为 `data:` URL，再回填到运行时 material。
- 同时修复模板与兼容加载器对 `data:` / `blob:` URL 的识别，避免错误拼接 `imagesBasePath`。

### 追加修改文件
- `js/offline-site-saver.js`
- `js/templates.js`
- `js/material.js`

---

## 功能增强 (2026-02-13) - 按钮文本与 Section/Page ID 可编辑

### 需求
- 编辑模式下，`data-material` 绑定到按钮的文案也应可直接编辑。
- 侧边栏中的 Section（可视作页面块）需要支持直接修改 `id`，而不只是改显示名称。

### 实现方案
1. **按钮文本可编辑**
   - 调整 `enableInlineEditing()` 的元素过滤规则，不再排除 `BUTTON`。
   - 现在所有非 `INPUT/TEXTAREA` 且带 `data-material` 的节点都可进入 `contenteditable` 编辑流程。

2. **Section/Page ID 可编辑**
   - 在编辑侧边栏卡片中新增 `ID: xxx` 展示行（`sidebar-section-id`）。
   - 支持双击该行进入编辑，`Enter` 或失焦提交。
   - 新增 `updateSectionId(oldId, newId)`：
     - 校验新 ID 格式（字母开头，只允许字母/数字/`_`/`-`）。
     - 校验重复 ID。
     - 同步迁移 `material.index[oldId] -> material.index[newId]`。
     - 更新 `material.config.sections` 中对应 section 的 `id`。
     - 触发重新渲染与刷新，确保页面结构和导航联动立即生效。

### 兼容与回退
- 若输入为空、格式非法或与现有 ID 冲突，会提示并回退到原 ID。
- 若输入与旧 ID 相同，不做额外变更。

### 修改文件
- `js/editor.js`

---

## 功能增强 (2026-02-14) - Card Grid 详情展开重构：翻转 + 放大

### 需求
- Card Grid 中点击 "Learn more" 后，卡片应**先做 3D 翻转**（露出背面详情内容），**再从原始位置放大到撑满整个 Card Grid 区域**。
- 展开后的详情面板是**内嵌在页面流中的**（in-flow），不影响网站整体滚动。
- 关闭时反向动画：先缩小回原位，再翻转回正面。
- 支持点击关闭按钮、点击外部区域、按 Esc 关闭。

### 实现方案
1. 模板结构重构为 `.cg-flipper` + `.cg-face-front` / `.cg-face-back`
2. JS 分两阶段动画：flip → enlarge (open) / shrink → flip back (close)
3. CSS 使用 `position: absolute` 内嵌放大，不锁定滚动

### 之前方案的否定
- 旧方案使用 `position: fixed` 全屏遮罩，锁定滚动，风格不一致
- 新方案改为内嵌翻转+放大，保持页面流

### 修改文件
- `js/templates.js`, `docs/js/templates.js`
- `js/section-renderer.js`, `docs/js/section-renderer.js`
- `css/input.css`, `css/styles.css`, `docs/css/styles.css`

---

## Bug修复 (2026-02-14) - Card Grid 展开仅单侧放大

### 问题现象
- 点击 Card Grid 的 "Learn more" 后，详情卡片只在一侧放大，未能像示意图那样覆盖整个卡片集合区域。

### 根因分析
- 桌面端 `.card-grid-item` 使用了 `max-width: calc((100% - 4rem) / 3)`。
- 展开动画虽然通过 JS 动态设置了更大的 `width`，但仍被 `max-width` 限制，导致视觉上只扩展到单卡宽度附近。

### 修复方案
- 在展开态 `.card-grid-item.cg-active.cg-enlarging` 上解除布局宽度约束：
  - `max-width: none;`
  - `flex: none;`
- 保持原有动画与关闭流程不变，仅修正展开目标尺寸被 CSS 限制的问题。

### 修改文件
- `css/input.css`
- `css/styles.css`
- `docs/css/styles.css`

---

## 功能增强 (2026-02-14) - docs Renewable Card Grid 详情渲染、表格与参考文献统一

### 本次目标
- 修复 `docs` 里 Card Grid 的 `detail` 文本可读性问题（原始长文本仅靠换行，结构弱）。
- 支持在 `detail` 中渲染比较表格，并确保表格在卡片详情中居中展示。
- 为 Renewable 卡片添加每卡片 References（Harvard 网页引用风格），并同步汇总到页脚 Reference。

### 实现内容
1. **Card Grid 详情格式化管线**
   - 在 `docs/js/templates.js` 新增 `formatCardGridDetail()`：
     - 纯文本自动转段落与列表（支持 `-/*/•`）。
     - 识别 markdown 风格表格并转换为语义化 `<table><thead><tbody>`。
     - 追加每卡片 `references` 列表渲染。
   - Card Grid 反面详情改为使用格式化输出（`detail-rich-text--formatted`），不影响其他模板详情逻辑。

2. **表格与 References 样式**
   - 在 `docs/css/styles.css` 增加：
     - `.detail-rich-text--formatted`（语义化内容布局）
     - `.detail-table-wrap/.detail-table`（横向溢出保护 + 表格居中 + 深色主题边框/底色）
     - `.detail-reference-*`（参考文献区块、链接样式）
   - 保留原 `.detail-rich-text` 作为旧文本兼容，格式化详情按新样式覆盖。

3. **Renewable 数据重构（docs）**
   - 更新 `docs/material.json` 的 `index.features.cards[0..4]`：
     - 清洗并结构化 Solar/Wind/Hydroelectric/Geothermal/Comparison 详情文案。
     - Comparison 卡片采用 markdown 表格行，交由格式化管线渲染为真实 `<table>`。
     - 每张卡增加 `references` 数组（Harvard 网页引用文案 + URL）。
   - 同步扩充 `index.footer.reference.items`（id 11-18）作为总 Reference 汇总。

### 影响与兼容
- 仅 `docs` 目录生效，不改变主站非 docs 运行链路。
- 不破坏既有 citation 点击逻辑（`.ref-cite` -> footer 高亮）；
  Renewable 本次新增的是每卡片底部引用列表与页脚汇总并存。

### 修改文件
- `docs/js/templates.js`
- `docs/css/styles.css`
- `docs/material.json`
- `Document/Log/v0.6_interactive_enhancements.md`

### 后续修正（2026-02-14，原文保留优先）
- 用户要求 Renewable 内容“尽可能保留原文”，不做大幅改写。
- 已将 `docs/material.json` 中 `features.cards[0..4].detail` 调整为**原文优先**版本：
  - 保留原文核心句式与信息顺序；
  - 仅做轻量排版整理（段落、列表、少量连接语）；
  - 保留 comparison 的表格结构（markdown table）以保证页面中居中表格渲染。
- References 维持上一版结构（卡片内 references + 页脚汇总 reference）。

### 再次修正（2026-02-14，公式与卡片引用显示）
- 问题：
  - Renewable 详情中的公式未按 KaTeX 渲染；
  - 每个 card 的 References 在页面中未显示。
- 根因：
  - `detail` 容器保留 `data-material` 时，会被 `docs/js/material.js` 用 `textContent` 覆盖，导致格式化 HTML（含 references）被抹掉。
- 修复：
  - 在 `docs/js/templates.js` 中，`detailIsHtml` 场景下不再为详情容器注入 `data-material`。
  - 在 `docs/material.json` 的 Renewable 详情文本中，将关键公式改为 KaTeX 可识别写法：
    - `$E = hf$`
    - `$E_k = \\frac{1}{2}mv^2$`
    - `$v^3$`
    - `$U = mgh$`

### 主编辑器同步修正（2026-02-14）
- 问题：之前修复落在 `docs/*` 查看版，主编辑器链路（根目录）仍未同步，导致编辑器内看不到 card 表格与每卡 references。
- 本次同步：
  - `js/templates.js`：同步加入 card detail 格式化管线（段落/列表/表格/每卡 references）；
  - `css/styles.css`：同步加入 `.detail-rich-text--formatted`、`.detail-table*`、`.detail-reference*` 样式；
  - `js/mode-manager.js`：调整数据加载优先级，`file://` 也优先尝试 `material.json`（fetch + XHR），再回退 embedded；
  - `material.json`：同步为 Renewable 卡片数据（含每卡 `references` 与 comparison 表格）；
  - `index.html`：同步 `material-inline-json` 内嵌 fallback，避免本地文件协议下回退到旧数据。

---

## 功能增强 (2026-02-14) - Details Banner 显示开关

### 需求
- 当前所有 details 界面默认都会显示顶部 banner。
- 需要新增一个开关，可按条目/区块控制 details 是否显示 banner。

### 实现方案
1. **模板层新增开关字段**
   - 在通用详情渲染函数 `renderDetailContent()` 增加 `showBanner`（默认 `true`）与 `detailBannerPath`。
   - 渲染 banner 时改为条件判断：`showBanner !== false` 才输出顶部媒体区。
2. **全模板接入**
   - 已接入以下 details 入口：
     - `highlights.items[*]`
     - `features.cards[*]`
     - `text-image-left/right` 对应 section
     - `closerLook.features[*]`
   - 兼容旧数据：未配置该字段时默认显示 banner（保持现有行为不变）。
3. **编辑模式开关控件**
   - 在 `js/editor.js` 新增详情 banner 控件（编辑模式可见）：
     - 在 details 面板上提供 `Show / Hide Details Banner` 开关按钮。
     - 点击后写回对应 material 路径并触发重渲染。
4. **新增条目默认值**
   - `tabbed-content / card-grid / accordion` 新增条目时，默认写入 `showDetailBanner: true`。

### 修改文件
- `js/templates.js`
- `docs/js/templates.js`
- `js/editor.js`
- `Document/Log/v0.6_interactive_enhancements.md`

### 后续修正（2026-02-14，编辑态交互冲突）
- 问题1：details 翻转后，已配置图片区域仍被“选择图片”覆盖层拦截，点击会触发上传弹窗。
- 问题2：details 中“显示/隐藏 banner”按钮与图片位置/缩放控制条存在重叠干扰。
- 修复（初版）：跳过 details 区域媒体，不再挂上传遮罩与位置控制条；用户反馈仍不行。
- 修复（二次，确保生效）：
  1. **模板**：`renderDetailMedia()` 为 details 媒体 div 增加 `data-detail-media="true"`，便于选择器精确排除。
  2. **编辑器**：`enableImageEditing()` 改为只对 `[data-material-img]:not([data-detail-media="true"])` 挂上传遮罩，不再依赖 DOM 层级判断。
  3. **section-renderer**：`initializeImagePositionControls()` 同样只对非 `[data-detail-media="true"]` 的图片挂位置/缩放控制条。
  4. **CSS**：翻转后正面不再接收点击，避免“背面可见但点击被正面抢走”：
     - `.flip-card.flipped .flip-card-front { pointer-events: none; }`（Tabbed / text-image / accordion）
     - `.cg-flipper.cg-flipped .cg-face-front { pointer-events: none; }`（Card Grid）
- 修改文件：`js/templates.js`、`docs/js/templates.js`、`js/editor.js`、`js/section-renderer.js`、`css/input.css`、`css/styles.css`、`docs/css/styles.css`。

### 功能调整（2026-02-14）- Details Banner 控制合并
- 需求：details 的 banner 也需要支持位置/缩放调整，且“显示 banner”按钮与位置/缩放控制放在同一控制条。
- 实现：
  1. **section-renderer**：`initializeImagePositionControls()` 恢复为对所有 `[data-material-img]` 添加 X/Y/Zoom/Reset 控制条（含 detail-banner-media、detail-end-media），以便在 details 反面也能调 banner 位置与缩放。
  2. **editor**：`enableDetailBannerToggles()` 改为优先把“显示/隐藏 banner”按钮插入到 **detail-banner-media 上的 .img-position-controls** 最前面（带分隔线），形成一条控制条：`[显示Banner] | X | Y | Zoom | Reset`；若无 banner 区域（banner 已关闭）则保留在面板上的浮动按钮作为回退。
  3. **CSS**：新增 `.img-position-controls .detail-banner-toggle-wrap`、`.img-position-banner-btn` 样式，使控制条内按钮与现有 X/Y/Zoom/Reset 视觉一致。
- 说明：details 区域媒体仍不挂“点击换图”遮罩（`enableImageEditing` 继续排除 `[data-detail-media="true"]`），避免误触上传；仅通过控制条操作 banner 显示与位置/缩放。
- 修改文件：`js/section-renderer.js`、`js/editor.js`、`css/input.css`、`css/styles.css`、`docs/css/styles.css`。

### 修正（2026-02-14）- 所有 details 统一使用同一条控制条
- 问题：逻辑本应对所有 details（tabbed-content、card-grid、text-image-left/right、accordion）生效，但 refresh 后 `enableDetailBannerToggles()` 先于 `initializeImagePositionControls()`（100ms 延迟）执行，非 card-grid 的 details 有时找不到控制条，只出现浮动按钮。
- 修复：
  1. **editor**：`enable()` 中除立即执行一次 `enableDetailBannerToggles()` 外，再在 150ms 后执行一次，确保在 `initializeImagePositionControls()` 挂好控制条后，所有 details 都能把“显示 banner”按钮注入同一条控制条；`disable()` 时清除该定时器。
  2. 向控制条注入按钮时，顺带移除该面板上已有的 `.detail-banner-config-controls` 浮动回退按钮，避免重复。
- 结果：tabbed-content、card-grid、text-image-left、text-image-right、accordion 的 details 反面均在同一控制条显示「显示Banner | X | Y | Zoom | Reset」。
