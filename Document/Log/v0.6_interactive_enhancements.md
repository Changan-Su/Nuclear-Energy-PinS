# Version 0.6 Development Log - Interactive Enhancements

## 开发时间
2026-02-12

## 版本目标
三项核心功能增强：
1. "Learn More" 按钮卡片翻转动画 + 详情编辑
2. 图片位置调整和缩放控制
3. LaTeX 数学公式渲染支持

## 功能一：卡片翻转动画（Learn More）

### 需求
- Highlights 区域中每个标签页的 "Learn More" 按钮，点击后应展示对应的详细内容
- 翻转动画需要符合 Apple 官网风格（流畅的 3D 翻转）
- 详情内容在编辑模式下可直接编辑

### 实现方案

**CSS 3D 翻转**:
- 使用 `perspective: 1200px` + `transform: rotateY(180deg)` 实现纵向翻转效果
- 过渡曲线 `cubic-bezier(0.4, 0.0, 0.2, 1)` 提供 Apple 风格的流畅感
- `backface-visibility: hidden` 确保正反面互不干扰

**DOM 结构调整**:
- 每个 tab content 内部包裹一个 `.flip-card` 容器
- 正面 `.flip-card-front`：原有内容（图片+标题+描述+按钮）
- 反面 `.flip-card-back`：详情内容（标题+分割线+详情文字+关闭按钮）

**数据层**:
- `material.json` 每个 highlight tab 新增 `detail` 字段，存储详情文本
- 详情文本支持 LaTeX 语法（配合功能三）

**交互逻辑**:
- 点击 "Learn More" 按钮 → `.flip-card` 添加 `.flipped` 类 → 触发 CSS 翻转
- 点击关闭按钮（X）→ 移除 `.flipped` 类 → 翻回正面
- 事件绑定在 `section-renderer.js` 的 `initializeFlipCards()` 中

### 文件变更
- `js/templates.js` — `tabbedContentTemplate()` 重构，增加翻转卡片结构
- `css/input.css` — 新增 `.flip-card`, `.flip-card-inner`, `.flip-card-front`, `.flip-card-back` 样式
- `material.json` — 每个 highlight tab 增加 `detail` 字段（含 LaTeX 示例内容）
- `js/section-renderer.js` — 新增 `initializeFlipCards()` 函数

---

## 功能二：图片位置与缩放控制

### 需求
- 编辑模式下，所有背景图片支持调整 X/Y 位置和缩放比例
- 调整参数持久化到 material 数据中
- 视图模式下控件隐藏

### 实现方案

**控件设计**:
- 底部居中的 floating 控制条（Apple 风格毛玻璃效果）
- 三个 range slider：X（0-100%）、Y（0-100%）、Zoom（50-300%）
- Reset 按钮恢复默认值（50%, 50%, 100%）

**数据结构**:
- 在 `images` 对象下新增 `position` 子对象：`{ x: 50, y: 50, scale: 100 }`
- 对于 card-grid 模板，使用 `imagePosition` 字段

**实时预览**:
- `input` 事件 → 实时更新 `background-position` 和 `background-size`
- `change` 事件 → 持久化到 material 数据

**CSS 可见性**:
- `.img-position-controls` 默认 `display: none`
- `body.edit-mode .img-position-controls` → `display: flex`

### 模板适配
所有带 `data-material-img` 的模板均已适配：
- Hero template（视频封面）
- Tabbed content template（高亮图片）
- Card grid template（卡片图片）
- Text-image-left / text-image-right（文图组合）
- Accordion template（closer look 图片）

### 文件变更
- `js/templates.js` — 所有模板函数增加 `imgPos` 解析逻辑，使用 `background-size: ${scale}%` 和 `background-position: ${x}% ${y}%`
- `js/section-renderer.js` — 新增 `initializeImagePositionControls()`, `applyImagePosition()`, `saveImagePosition()`, `getNestedValue()`, `setNestedValue()` 函数
- `css/input.css` — 新增 `.img-position-controls` 样式系统（毛玻璃背景、range slider 自定义主题、reset 按钮）

---

## 功能三：LaTeX 数学公式渲染

### 需求
- 文本内容支持 LaTeX 语法的数学公式显示
- 兼容行内公式 `$...$` 和独立公式 `$$...$$`
- 支持 `\(...\)` 和 `\[...\]` 语法

### 实现方案

**KaTeX 集成**:
- 引入 KaTeX v0.16.11（CDN）：CSS + JS + auto-render 插件
- 使用 `defer` 加载，不阻塞页面渲染

**渲染模块** (`js/latex-renderer.js`):
- `renderAll()`: 渲染页面中所有 `[data-material]` 和 `.latex-content` 元素中的 LaTeX
- `renderElement(el)`: 渲染指定元素
- `renderString(text)`: 将包含 LaTeX 的字符串转换为 HTML
- 自动等待 KaTeX 加载完成（轮询机制，最多 5 秒）

**Delimiter 配置**:
```javascript
delimiters: [
  { left: '$$', right: '$$', display: true },
  { left: '$', right: '$', display: false },
  { left: '\\(', right: '\\)', display: false },
  { left: '\\[', right: '\\]', display: true }
]
```

**集成点**:
- `section-renderer.js` 的 `reinitializeComponents()` 中调用 `LatexRenderer.renderAll()`
- 每次内容重渲染后自动触发 LaTeX 渲染

### 示例内容
material.json 中的 detail 字段已包含 LaTeX 示例：
- Efficiency: `$200\,\text{MeV}$`
- Zero Carbon: `$12\,\text{g CO}_2/\text{kWh}$`, `$820\,\text{g CO}_2/\text{kWh}$`
- Safety: `$1 \times 10^{-7}$`

### 文件变更
- `js/latex-renderer.js` — **新增文件**，LaTeX 渲染模块
- `index.html` — 引入 KaTeX CDN（CSS + JS + auto-render），加载 `latex-renderer.js`
- `js/section-renderer.js` — `reinitializeComponents()` 增加 `LatexRenderer.renderAll()` 调用

---

## 技术亮点

### 1. CSS 3D 翻转
- 使用纯 CSS 实现，无需 JS 动画库
- `transform-style: preserve-3d` 保持 3D 空间
- 适当的 `perspective` 值提供自然的深度感

### 2. 数据驱动的图片控制
- 位置/缩放参数存储在 material JSON 中，支持 undo/redo
- 实时预览 + 延迟保存的双轨策略

### 3. 惰性 LaTeX 渲染
- KaTeX 使用 defer 加载，不影响首屏渲染
- 渲染器内部有轮询等待机制，确保 KaTeX 就绪后才执行
- `throwOnError: false` 确保格式错误的公式不会破坏页面

## 文件变更清单

### 新增文件
- `js/latex-renderer.js` — LaTeX 渲染模块

### 修改的文件
- `js/templates.js` — 翻转卡片结构 + 图片位置参数支持
- `js/section-renderer.js` — 翻转卡片初始化 + 图片控制初始化 + LaTeX 渲染
- `css/input.css` — 翻转动画样式 + 图片控制条样式
- `index.html` — KaTeX CDN 引入 + latex-renderer.js 加载 + 内嵌数据更新
- `material.json` — highlight tabs 增加 detail 字段

### 更新的文档
- `Document/Log/v0.6_interactive_enhancements.md`（本文件）

## Bug修复 (2026-02-13)

### 问题：Grid Card 不显示
**症状**: Features 部分的三个卡片（Benefits 区域）在页面上不可见。

**根本原因**:
1. 在 `cardGridTemplate` 中，每个卡片被包裹在 `<div class="fade-in-up">` 中用于滚动动画
2. `fade-in-up` 类设置了 `opacity: 0` 和 `transform: translateY(20px)`
3. 外层 div 没有明确高度，导致：
   - 即使 flip-card 包装器设置了 `h-[560px]`，外层 div 可能崩塌为 0 高度
   - Intersection Observer 无法正确检测到元素进入视口
   - 动画未触发，卡片保持 `opacity: 0` 不可见

**修复方案**:
- 将 `h-[560px]` 高度类从内层 flip-card 包装器移到外层 `fade-in-up` div
- flip-card 包装器改用 `h-full` 继承父容器高度
- 移除 frontHtml 中冗余的 transition-delay（外层已有）

**修改文件**:
- `js/templates.js` — `cardGridTemplate()` 函数，调整高度分配逻辑

**技术要点**:
- CSS Intersection Observer 依赖元素的实际尺寸来判断是否进入视口
- 动画容器必须有明确的尺寸，否则会导致布局崩塌
- Tailwind 的 flex/grid 子项高度继承需要父容器有确定高度

---

## 参考的前置工作
- v0.5: SVG Template Gallery
- v0.4: Reference Citation System
- v0.3: CMS Online Editing System
- v0.2: Frontend Build
- v0.1: Initial Setup
